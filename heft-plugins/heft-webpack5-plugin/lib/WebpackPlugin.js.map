{"version":3,"file":"WebpackPlugin.js","sourceRoot":"","sources":["../src/WebpackPlugin.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as nodePath from 'path';\r\nimport webpack from 'webpack';\r\nimport type TWebpackDevServer from 'webpack-dev-server';\r\nimport { LegacyAdapters, Path } from '@rushstack/node-core-library';\r\nimport type {\r\n  HeftConfiguration,\r\n  HeftSession,\r\n  IBuildStageContext,\r\n  IBuildStageProperties,\r\n  IBundleSubstage,\r\n  IHeftPlugin,\r\n  ScopedLogger\r\n} from '@rushstack/heft';\r\nimport {\r\n  IWebpackConfiguration,\r\n  IWebpackBundleSubstageProperties,\r\n  IWebpackBuildStageProperties,\r\n  IWebpackVersions,\r\n  getWebpackVersions\r\n} from './shared';\r\nimport { WebpackConfigurationLoader } from './WebpackConfigurationLoader';\r\n\r\nconst PLUGIN_NAME: string = 'WebpackPlugin';\r\nconst WEBPACK_DEV_SERVER_PACKAGE_NAME: string = 'webpack-dev-server';\r\nconst WEBPACK_DEV_SERVER_ENV_VAR_NAME: string = 'WEBPACK_DEV_SERVER';\r\n\r\n/**\r\n * @internal\r\n */\r\nexport class WebpackPlugin implements IHeftPlugin {\r\n  public readonly pluginName: string = PLUGIN_NAME;\r\n\r\n  public apply(heftSession: HeftSession, heftConfiguration: HeftConfiguration): void {\r\n    heftSession.hooks.build.tap(PLUGIN_NAME, (build: IBuildStageContext) => {\r\n      build.hooks.bundle.tap(PLUGIN_NAME, (bundle: IBundleSubstage) => {\r\n        bundle.hooks.configureWebpack.tap(\r\n          { name: PLUGIN_NAME, stage: Number.MIN_SAFE_INTEGER },\r\n          (webpackConfiguration: unknown) => {\r\n            const webpackVersions: IWebpackVersions = getWebpackVersions();\r\n            bundle.properties.webpackVersion = webpack.version;\r\n            bundle.properties.webpackDevServerVersion = webpackVersions.webpackDevServerVersion;\r\n\r\n            return webpackConfiguration;\r\n          }\r\n        );\r\n\r\n        bundle.hooks.configureWebpack.tapPromise(PLUGIN_NAME, async (existingConfiguration: unknown) => {\r\n          const logger: ScopedLogger = heftSession.requestScopedLogger('configure-webpack');\r\n          if (existingConfiguration) {\r\n            logger.terminal.writeVerboseLine(\r\n              'Skipping loading webpack config file because the webpack config has already been set.'\r\n            );\r\n            return existingConfiguration;\r\n          } else {\r\n            return await WebpackConfigurationLoader.tryLoadWebpackConfigAsync(\r\n              logger,\r\n              heftConfiguration.buildFolder,\r\n              build.properties\r\n            );\r\n          }\r\n        });\r\n\r\n        bundle.hooks.run.tapPromise(PLUGIN_NAME, async () => {\r\n          await this._runWebpackAsync(\r\n            heftSession,\r\n            heftConfiguration,\r\n            bundle.properties as IWebpackBundleSubstageProperties,\r\n            build.properties,\r\n            heftConfiguration.terminalProvider.supportsColor\r\n          );\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  private async _runWebpackAsync(\r\n    heftSession: HeftSession,\r\n    heftConfiguration: HeftConfiguration,\r\n    bundleSubstageProperties: IWebpackBundleSubstageProperties,\r\n    buildProperties: IBuildStageProperties,\r\n    supportsColor: boolean\r\n  ): Promise<void> {\r\n    const webpackConfiguration: IWebpackConfiguration = bundleSubstageProperties.webpackConfiguration;\r\n    if (!webpackConfiguration) {\r\n      return;\r\n    }\r\n\r\n    const logger: ScopedLogger = heftSession.requestScopedLogger('webpack');\r\n    const webpackVersions: IWebpackVersions = getWebpackVersions();\r\n    if (bundleSubstageProperties.webpackVersion !== webpackVersions.webpackVersion) {\r\n      logger.emitError(\r\n        new Error(\r\n          `The Webpack plugin expected to be configured with Webpack version ${webpackVersions.webpackVersion}, ` +\r\n            `but the configuration specifies version ${bundleSubstageProperties.webpackVersion}. ` +\r\n            'Are multiple versions of the Webpack plugin present?'\r\n        )\r\n      );\r\n    }\r\n\r\n    if (bundleSubstageProperties.webpackDevServerVersion !== webpackVersions.webpackDevServerVersion) {\r\n      logger.emitError(\r\n        new Error(\r\n          `The Webpack plugin expected to be configured with webpack-dev-server version ${webpackVersions.webpackDevServerVersion}, ` +\r\n            `but the configuration specifies version ${bundleSubstageProperties.webpackDevServerVersion}. ` +\r\n            'Are multiple versions of the Webpack plugin present?'\r\n        )\r\n      );\r\n    }\r\n\r\n    logger.terminal.writeLine(`Using Webpack version ${webpack.version}`);\r\n\r\n    const compiler: webpack.Compiler | webpack.MultiCompiler = Array.isArray(webpackConfiguration)\r\n      ? webpack(webpackConfiguration) /* (webpack.Compilation[]) => webpack.MultiCompiler */\r\n      : webpack(webpackConfiguration); /* (webpack.Compilation) => webpack.Compiler */\r\n\r\n    if (buildProperties.serveMode) {\r\n      const defaultDevServerOptions: TWebpackDevServer.Configuration = {\r\n        host: 'localhost',\r\n        publicPath: '/',\r\n        filename: '[name]_[hash].js',\r\n        clientLogLevel: 'info',\r\n        stats: {\r\n          cached: false,\r\n          cachedAssets: false,\r\n          colors: supportsColor\r\n        },\r\n        port: 8080\r\n      };\r\n\r\n      let options: TWebpackDevServer.Configuration;\r\n      if (Array.isArray(webpackConfiguration)) {\r\n        const devServerOptions: TWebpackDevServer.Configuration[] = webpackConfiguration\r\n          .map((configuration) => configuration.devServer)\r\n          .filter((devServer): devServer is TWebpackDevServer.Configuration => !!devServer);\r\n        if (devServerOptions.length > 1) {\r\n          logger.emitWarning(\r\n            new Error(`Detected multiple webpack devServer configurations, using the first one.`)\r\n          );\r\n        }\r\n\r\n        if (devServerOptions.length > 0) {\r\n          options = { ...defaultDevServerOptions, ...devServerOptions[0] };\r\n        } else {\r\n          options = defaultDevServerOptions;\r\n        }\r\n      } else {\r\n        options = { ...defaultDevServerOptions, ...webpackConfiguration.devServer };\r\n      }\r\n\r\n      // Register a plugin to callback after webpack is done with the first compilation\r\n      // so we can move on to post-build\r\n      let firstCompilationDoneCallback: (() => void) | undefined;\r\n      const originalBeforeCallback: typeof options.before | undefined = options.before;\r\n      options.before = (app, devServer, compiler: webpack.Compiler) => {\r\n        compiler.hooks.done.tap('heft-webpack-plugin', () => {\r\n          if (firstCompilationDoneCallback) {\r\n            firstCompilationDoneCallback();\r\n            firstCompilationDoneCallback = undefined;\r\n          }\r\n        });\r\n\r\n        if (originalBeforeCallback) {\r\n          return originalBeforeCallback(app, devServer, compiler);\r\n        }\r\n      };\r\n\r\n      // The webpack-dev-server package has a design flaw, where merely loading its package will set the\r\n      // WEBPACK_DEV_SERVER environment variable -- even if no APIs are accessed. This environment variable\r\n      // causes incorrect behavior if Heft is not running in serve mode. Thus, we need to be careful to call require()\r\n      // only if Heft is in serve mode.\r\n      const WebpackDevServer: typeof TWebpackDevServer = require(WEBPACK_DEV_SERVER_PACKAGE_NAME);\r\n      // TODO: the WebpackDevServer accepts a third parameter for a logger. We should make\r\n      // use of that to make logging cleaner\r\n      const webpackDevServer: TWebpackDevServer = new WebpackDevServer(compiler, options);\r\n      await new Promise<void>((resolve: () => void, reject: (error: Error) => void) => {\r\n        firstCompilationDoneCallback = resolve;\r\n\r\n        webpackDevServer.listen(options.port!, options.host!, (error: Error | undefined) => {\r\n          if (error) {\r\n            reject(error);\r\n          }\r\n        });\r\n      });\r\n    } else {\r\n      if (process.env[WEBPACK_DEV_SERVER_ENV_VAR_NAME]) {\r\n        logger.emitWarning(\r\n          new Error(\r\n            `The \"${WEBPACK_DEV_SERVER_ENV_VAR_NAME}\" environment variable is set, ` +\r\n              'which will cause problems when webpack is not running in serve mode. ' +\r\n              `(Did a dependency inadvertently load the \"${WEBPACK_DEV_SERVER_PACKAGE_NAME}\" package?)`\r\n          )\r\n        );\r\n      }\r\n\r\n      let stats: webpack.Stats | webpack.MultiStats | undefined;\r\n      if (buildProperties.watchMode) {\r\n        try {\r\n          stats = await LegacyAdapters.convertCallbackToPromise(\r\n            (compiler as webpack.Compiler).watch.bind(compiler),\r\n            {}\r\n          );\r\n        } catch (e) {\r\n          logger.emitError(e);\r\n        }\r\n      } else {\r\n        try {\r\n          stats = await LegacyAdapters.convertCallbackToPromise(\r\n            (compiler as webpack.Compiler).run.bind(compiler)\r\n          );\r\n          await LegacyAdapters.convertCallbackToPromise(compiler.close.bind(compiler));\r\n        } catch (e) {\r\n          logger.emitError(e);\r\n        }\r\n      }\r\n\r\n      if (stats) {\r\n        // eslint-disable-next-line require-atomic-updates\r\n        (buildProperties as IWebpackBuildStageProperties).webpackStats = stats;\r\n\r\n        this._emitErrors(logger, heftConfiguration.buildFolder, stats);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _emitErrors(\r\n    logger: ScopedLogger,\r\n    buildFolder: string,\r\n    stats: webpack.Stats | webpack.MultiStats\r\n  ): void {\r\n    if (stats.hasErrors() || stats.hasWarnings()) {\r\n      const serializedStats: webpack.StatsCompilation = stats.toJson('errors-warnings');\r\n\r\n      if (serializedStats.warnings) {\r\n        for (const warning of serializedStats.warnings) {\r\n          logger.emitWarning(this._normalizeError(buildFolder, warning));\r\n        }\r\n      }\r\n\r\n      if (serializedStats.errors) {\r\n        for (const error of serializedStats.errors) {\r\n          logger.emitError(this._normalizeError(buildFolder, error));\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private _normalizeError(buildFolder: string, error: webpack.StatsError): Error {\r\n    if (error instanceof Error) {\r\n      return error;\r\n    } else {\r\n      let moduleName: string | undefined = error.moduleName;\r\n      if (!moduleName && error.moduleIdentifier) {\r\n        moduleName = Path.convertToSlashes(nodePath.relative(buildFolder, error.moduleIdentifier));\r\n      }\r\n\r\n      let formattedError: string;\r\n      if (error.loc && moduleName) {\r\n        formattedError = `${moduleName}:${error.loc} - ${error.message}`;\r\n      } else if (moduleName) {\r\n        formattedError = `${moduleName} - ${error.message}`;\r\n      } else {\r\n        formattedError = error.message;\r\n      }\r\n\r\n      return new Error(formattedError);\r\n    }\r\n  }\r\n}\r\n"]}