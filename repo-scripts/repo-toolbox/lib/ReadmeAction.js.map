{"version":3,"file":"ReadmeAction.js","sourceRoot":"","sources":["../src/ReadmeAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See the @microsoft/rush package's LICENSE file for license information.\r\n\r\nimport * as path from 'path';\r\nimport { StringBuilder, Text, Sort, FileSystem } from '@rushstack/node-core-library';\r\nimport { RushConfiguration, RushConfigurationProject, LockStepVersionPolicy } from '@microsoft/rush-lib';\r\nimport { CommandLineAction } from '@rushstack/ts-command-line';\r\n\r\nconst GENERATED_PROJECT_SUMMARY_START_COMMENT_TEXT: string = '<!-- GENERATED PROJECT SUMMARY START -->';\r\nconst GENERATED_PROJECT_SUMMARY_END_COMMENT_TEXT: string = '<!-- GENERATED PROJECT SUMMARY END -->';\r\n\r\nexport class ReadmeAction extends CommandLineAction {\r\n  public constructor() {\r\n    super({\r\n      actionName: 'readme',\r\n      summary: 'Generates README.md project table based on rush.json inventory',\r\n      documentation: \"Use this to update the repo's README.md\"\r\n    });\r\n  }\r\n\r\n  private static _isPublished(project: RushConfigurationProject): boolean {\r\n    return project.shouldPublish || !!project.versionPolicyName;\r\n  }\r\n\r\n  protected async onExecute(): Promise<void> {\r\n    // abstract\r\n\r\n    const rushConfiguration: RushConfiguration = RushConfiguration.loadFromDefaultLocation();\r\n\r\n    const repoReadmePath: string = path.resolve(rushConfiguration.rushJsonFolder, 'README.md');\r\n    const existingReadme: string = await FileSystem.readFileAsync(repoReadmePath);\r\n    const generatedProjectSummaryStartIndex: number = existingReadme.indexOf(\r\n      GENERATED_PROJECT_SUMMARY_START_COMMENT_TEXT\r\n    );\r\n    const generatedProjectSummaryEndIndex: number = existingReadme.indexOf(\r\n      GENERATED_PROJECT_SUMMARY_END_COMMENT_TEXT\r\n    );\r\n\r\n    if (generatedProjectSummaryStartIndex === -1 || generatedProjectSummaryEndIndex === -1) {\r\n      throw new Error(\r\n        `Unable to find \"${GENERATED_PROJECT_SUMMARY_START_COMMENT_TEXT}\" or ` +\r\n          `\"${GENERATED_PROJECT_SUMMARY_END_COMMENT_TEXT}\" comment in \"${repoReadmePath}\"`\r\n      );\r\n    }\r\n\r\n    const readmePrefix: string = existingReadme.substr(\r\n      0,\r\n      generatedProjectSummaryStartIndex + GENERATED_PROJECT_SUMMARY_START_COMMENT_TEXT.length\r\n    );\r\n\r\n    const readmePostfix: string = existingReadme.substr(generatedProjectSummaryEndIndex);\r\n\r\n    const builder: StringBuilder = new StringBuilder();\r\n    const orderedProjects: RushConfigurationProject[] = [...rushConfiguration.projects];\r\n    Sort.sortBy(orderedProjects, (x) => x.projectRelativeFolder);\r\n\r\n    builder.append(readmePrefix);\r\n    builder.append('\\n');\r\n    builder.append('\\n');\r\n    builder.append('## Published Packages\\n\\n');\r\n    builder.append('<!-- the table below was generated using the ./repo-scripts/repo-toolbox script -->\\n\\n');\r\n    builder.append('| Folder | Version | Changelog | Package |\\n');\r\n    builder.append('| ------ | ------- | --------- | ------- |\\n');\r\n    for (const project of orderedProjects.filter((x) => ReadmeAction._isPublished(x))) {\r\n      // Example:\r\n      //\r\n      // | [/apps/api-extractor](./apps/api-extractor/)\r\n      // | [![npm version](https://badge.fury.io/js/%40microsoft%2Fapi-extractor.svg\r\n      //     )](https://badge.fury.io/js/%40microsoft%2Fapi-extractor)\r\n      // | [changelog](./apps/api-extractor/CHANGELOG.md)\r\n      // | [@microsoft/api-extractor](https://www.npmjs.com/package/@microsoft/api-extractor)\r\n      // |\r\n\r\n      const scopedName: string = project.packageName; // \"@microsoft/api-extractor\"\r\n      const folderPath: string = project.projectRelativeFolder; // \"apps/api-extractor\"\r\n      let escapedScopedName: string = scopedName; // \"%40microsoft%2Fapi-extractor\"\r\n      escapedScopedName = Text.replaceAll(escapedScopedName, '/', '%2F');\r\n      escapedScopedName = Text.replaceAll(escapedScopedName, '@', '%40');\r\n\r\n      // | [/apps/api-extractor](./apps/api-extractor/)\r\n      builder.append(`| [/${folderPath}](./${folderPath}/) `);\r\n\r\n      // | [![npm version](https://badge.fury.io/js/%40microsoft%2Fapi-extractor.svg\r\n      //     )](https://badge.fury.io/js/%40microsoft%2Fapi-extractor)\r\n      builder.append(\r\n        `| [![npm version](https://badge.fury.io/js/${escapedScopedName}.svg)]` +\r\n          `(https://badge.fury.io/js/${escapedScopedName}) `\r\n      );\r\n\r\n      let hasChangeLog: boolean = true;\r\n      if (project.versionPolicy instanceof LockStepVersionPolicy) {\r\n        if (project.versionPolicy.mainProject) {\r\n          if (project.versionPolicy.mainProject !== project.packageName) {\r\n            hasChangeLog = false;\r\n          }\r\n        }\r\n      }\r\n\r\n      // | [changelog](./apps/api-extractor/CHANGELOG.md)\r\n      if (hasChangeLog) {\r\n        builder.append(`| [changelog](./${folderPath}/CHANGELOG.md) `);\r\n      } else {\r\n        builder.append(`| `);\r\n      }\r\n\r\n      // | [@microsoft/api-extractor](https://www.npmjs.com/package/@microsoft/api-extractor)\r\n      builder.append(`| [${scopedName}](https://www.npmjs.com/package/${scopedName}) `);\r\n\r\n      builder.append(`|\\n`);\r\n    }\r\n\r\n    builder.append('\\n\\n## Unpublished Local Projects\\n\\n');\r\n    builder.append('<!-- the table below was generated using the ./repo-scripts/repo-toolbox script -->\\n\\n');\r\n    builder.append('| Folder | Description |\\n');\r\n    builder.append('| ------ | -----------|\\n');\r\n    for (const project of orderedProjects.filter((x) => !ReadmeAction._isPublished(x))) {\r\n      const folderPath: string = project.projectRelativeFolder; // \"apps/api-extractor\"\r\n\r\n      // | [/apps/api-extractor](./apps/api-extractor/)\r\n      builder.append(`| [/${folderPath}](./${folderPath}/) `);\r\n\r\n      const description: string = (project.packageJson.description || '').replace(/[\\n\\r|]+/g, '');\r\n\r\n      builder.append(`| ${description} `);\r\n\r\n      builder.append(`|\\n`);\r\n    }\r\n\r\n    builder.append(readmePostfix);\r\n\r\n    console.log(`Writing ${repoReadmePath}`);\r\n    FileSystem.writeFile(repoReadmePath, builder.toString());\r\n\r\n    console.log('\\nSuccess.');\r\n  }\r\n\r\n  protected onDefineParameters(): void {\r\n    // abstract\r\n  }\r\n}\r\n"]}