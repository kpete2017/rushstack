{"version":3,"file":"ApiExtractorPlugin.js","sourceRoot":"","sources":["../../../src/plugins/ApiExtractorPlugin/ApiExtractorPlugin.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport { IHeftPlugin } from '../../pluginFramework/IHeftPlugin';\r\nimport { HeftSession } from '../../pluginFramework/HeftSession';\r\nimport { HeftConfiguration } from '../../configuration/HeftConfiguration';\r\nimport { ApiExtractorRunner } from './ApiExtractorRunner';\r\nimport { IBuildStageContext, IBundleSubstage } from '../../stages/BuildStage';\r\nimport { CoreConfigFiles } from '../../utilities/CoreConfigFiles';\r\nimport { ScopedLogger } from '../../pluginFramework/logging/ScopedLogger';\r\nimport { IToolPackageResolution, ToolPackageResolver } from '../../utilities/ToolPackageResolver';\r\n\r\nconst PLUGIN_NAME: string = 'ApiExtractorPlugin';\r\nconst CONFIG_FILE_LOCATION: string = './config/api-extractor.json';\r\n\r\nexport interface IApiExtractorPluginConfiguration {\r\n  /**\r\n   * If set to true, use the project's TypeScript compiler version for API Extractor's\r\n   * analysis. API Extractor's included TypeScript compiler can generally correctly\r\n   * analyze typings generated by older compilers, and referencing the project's compiler\r\n   * can cause issues. If issues are encountered with API Extractor's included compiler,\r\n   * set this option to true.\r\n   *\r\n   * This corresponds to API Extractor's `--typescript-compiler-folder` CLI option and\r\n   * `IExtractorInvokeOptions.typescriptCompilerFolder` API option. This option defaults to false.\r\n   */\r\n  useProjectTypescriptVersion?: boolean;\r\n}\r\n\r\ninterface IRunApiExtractorOptions {\r\n  heftConfiguration: HeftConfiguration;\r\n  buildFolder: string;\r\n  debugMode: boolean;\r\n  watchMode: boolean;\r\n  production: boolean;\r\n  apiExtractorJsonFilePath: string;\r\n}\r\n\r\nexport class ApiExtractorPlugin implements IHeftPlugin {\r\n  public readonly pluginName: string = PLUGIN_NAME;\r\n\r\n  private readonly _toolPackageResolver: ToolPackageResolver;\r\n\r\n  public constructor(taskPackageResolver: ToolPackageResolver) {\r\n    this._toolPackageResolver = taskPackageResolver;\r\n  }\r\n\r\n  public apply(heftSession: HeftSession, heftConfiguration: HeftConfiguration): void {\r\n    const { buildFolder } = heftConfiguration;\r\n\r\n    heftSession.hooks.build.tap(PLUGIN_NAME, async (build: IBuildStageContext) => {\r\n      build.hooks.bundle.tap(PLUGIN_NAME, (bundle: IBundleSubstage) => {\r\n        bundle.hooks.run.tapPromise(PLUGIN_NAME, async () => {\r\n          // API Extractor provides an ExtractorConfig.tryLoadForFolder() API that will probe for api-extractor.json\r\n          // including support for rig.json.  However, Heft does not load the @microsoft/api-extractor package at all\r\n          // unless it sees a config/api-extractor.json file.  Thus we need to do our own lookup here.\r\n          const apiExtractorJsonFilePath: string | undefined =\r\n            await heftConfiguration.rigConfig.tryResolveConfigFilePathAsync(CONFIG_FILE_LOCATION);\r\n\r\n          if (apiExtractorJsonFilePath !== undefined) {\r\n            await this._runApiExtractorAsync(heftSession, {\r\n              heftConfiguration,\r\n              buildFolder,\r\n              debugMode: heftSession.debugMode,\r\n              watchMode: build.properties.watchMode,\r\n              production: build.properties.production,\r\n              apiExtractorJsonFilePath: apiExtractorJsonFilePath\r\n            });\r\n          }\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  private async _runApiExtractorAsync(\r\n    heftSession: HeftSession,\r\n    options: IRunApiExtractorOptions\r\n  ): Promise<void> {\r\n    const { heftConfiguration, buildFolder, debugMode, watchMode, production } = options;\r\n\r\n    const logger: ScopedLogger = heftSession.requestScopedLogger('API Extractor Plugin');\r\n\r\n    const apiExtractorTaskConfiguration: IApiExtractorPluginConfiguration | undefined =\r\n      await CoreConfigFiles.apiExtractorTaskConfigurationLoader.tryLoadConfigurationFileForProjectAsync(\r\n        logger.terminal,\r\n        heftConfiguration.buildFolder,\r\n        heftConfiguration.rigConfig\r\n      );\r\n\r\n    if (watchMode) {\r\n      logger.terminal.writeWarningLine(\"API Extractor isn't currently supported in --watch mode.\");\r\n      return;\r\n    }\r\n\r\n    const resolution: IToolPackageResolution | undefined =\r\n      await this._toolPackageResolver.resolveToolPackagesAsync(options.heftConfiguration, logger.terminal);\r\n\r\n    if (!resolution) {\r\n      logger.emitError(new Error('Unable to resolve a compiler package for tsconfig.json'));\r\n      return;\r\n    }\r\n\r\n    if (!resolution.apiExtractorPackagePath) {\r\n      logger.emitError(\r\n        new Error('Unable to resolve the \"@microsoft/api-extractor\" package for this project')\r\n      );\r\n      return;\r\n    }\r\n\r\n    const apiExtractorRunner: ApiExtractorRunner = new ApiExtractorRunner(\r\n      heftConfiguration.terminalProvider,\r\n      {\r\n        apiExtractorJsonFilePath: options.apiExtractorJsonFilePath,\r\n        apiExtractorPackagePath: resolution.apiExtractorPackagePath,\r\n        typescriptPackagePath: apiExtractorTaskConfiguration?.useProjectTypescriptVersion\r\n          ? resolution.typeScriptPackagePath\r\n          : undefined,\r\n        buildFolder: buildFolder,\r\n        production: production\r\n      },\r\n      heftSession\r\n    );\r\n    if (debugMode) {\r\n      await apiExtractorRunner.invokeAsync();\r\n    } else {\r\n      await apiExtractorRunner.invokeAsSubprocessAsync();\r\n    }\r\n  }\r\n}\r\n"]}