{"version":3,"file":"NodeServicePlugin.js","sourceRoot":"","sources":["../../src/plugins/NodeServicePlugin.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as child_process from 'child_process';\r\nimport * as process from 'process';\r\nimport { performance } from 'perf_hooks';\r\nimport { InternalError } from '@rushstack/node-core-library';\r\n\r\nimport { HeftSession } from '../pluginFramework/HeftSession';\r\nimport { HeftConfiguration } from '../configuration/HeftConfiguration';\r\nimport { IBuildStageContext, ICompileSubstage, IPostBuildSubstage } from '../stages/BuildStage';\r\nimport { ScopedLogger } from '../pluginFramework/logging/ScopedLogger';\r\nimport { IHeftPlugin } from '../pluginFramework/IHeftPlugin';\r\nimport { CoreConfigFiles } from '../utilities/CoreConfigFiles';\r\nimport { SubprocessTerminator } from '../utilities/subprocess/SubprocessTerminator';\r\n\r\nconst PLUGIN_NAME: string = 'NodeServicePlugin';\r\n\r\nexport interface INodeServicePluginCompleteConfiguration {\r\n  commandName: string;\r\n  ignoreMissingScript: boolean;\r\n  waitBeforeRestartMs: number;\r\n  waitForTerminateMs: number;\r\n  waitForKillMs: number;\r\n}\r\n\r\nexport interface INodeServicePluginConfiguration extends Partial<INodeServicePluginCompleteConfiguration> {}\r\n\r\nenum State {\r\n  /**\r\n   * The service process is not running, and _activeChildProcess is undefined.\r\n   *\r\n   * In this state, there may or may not be a timeout scheduled that will later restart the service.\r\n   */\r\n  Stopped,\r\n\r\n  /**\r\n   * The service process is running normally.\r\n   */\r\n  Running,\r\n\r\n  /**\r\n   * The SIGTERM signal has been sent to the service process, and we are waiting for it\r\n   * to shut down gracefully.\r\n   *\r\n   * NOTE: On Windows OS, SIGTERM is skipped and we proceed directly to SIGKILL.\r\n   */\r\n  Stopping,\r\n\r\n  /**\r\n   * The SIGKILL signal has been sent to forcibly terminate the service process, and we are waiting\r\n   * to confirm that the operation has completed.\r\n   */\r\n  Killing\r\n}\r\n\r\nexport class NodeServicePlugin implements IHeftPlugin {\r\n  public readonly pluginName: string = PLUGIN_NAME;\r\n\r\n  private static readonly _isWindows: boolean = process.platform === 'win32';\r\n\r\n  private _logger!: ScopedLogger;\r\n\r\n  private _activeChildProcess: child_process.ChildProcess | undefined;\r\n\r\n  private _state: State = State.Stopped;\r\n\r\n  /**\r\n   * The state machine schedules at most one setInterval() timeout at any given time.  It is for:\r\n   *\r\n   * - waitBeforeRestartMs in State.Stopped\r\n   * - waitForTerminateMs in State.Stopping\r\n   * - waitForKillMs in State.Killing\r\n   */\r\n  private _timeout: NodeJS.Timeout | undefined = undefined;\r\n\r\n  /**\r\n   * Used by _scheduleRestart().  The process will be automatically restarted when performance.now()\r\n   * exceeds this time.\r\n   */\r\n  private _restartTime: number | undefined = undefined;\r\n\r\n  /**\r\n   * The data read from the node-service.json config file, or \"undefined\" if the file is missing.\r\n   */\r\n  private _rawConfiguration: INodeServicePluginConfiguration | undefined = undefined;\r\n\r\n  /**\r\n   * The effective configuration, with defaults applied.\r\n   */\r\n  private _configuration!: INodeServicePluginCompleteConfiguration;\r\n\r\n  /**\r\n   * The script body obtained from the \"scripts\" section in the project's package.json.\r\n   */\r\n  private _shellCommand: string | undefined;\r\n\r\n  /**\r\n   * This is set to true when the child process terminates unexpectedly (for example, something like\r\n   * \"the service listening port is already in use\" or \"unable to authenticate to the database\").\r\n   * Rather than attempting to restart in a potentially endless loop, instead we will wait until \"watch mode\"\r\n   * recompiles the project.\r\n   */\r\n  private _childProcessFailed: boolean = false;\r\n\r\n  private _pluginEnabled: boolean = false;\r\n\r\n  public apply(heftSession: HeftSession, heftConfiguration: HeftConfiguration): void {\r\n    this._logger = heftSession.requestScopedLogger('node-service');\r\n\r\n    heftSession.hooks.build.tap(PLUGIN_NAME, (build: IBuildStageContext) => {\r\n      if (!build.properties.serveMode) {\r\n        // This plugin is only used with \"heft start\"\r\n        return;\r\n      }\r\n\r\n      build.hooks.loadStageConfiguration.tapPromise(PLUGIN_NAME, async () => {\r\n        await this._loadStageConfiguration(heftConfiguration);\r\n\r\n        if (this._pluginEnabled) {\r\n          build.hooks.postBuild.tap(PLUGIN_NAME, (bundle: IPostBuildSubstage) => {\r\n            bundle.hooks.run.tapPromise(PLUGIN_NAME, async () => {\r\n              await this._runCommandAsync(heftSession, heftConfiguration);\r\n            });\r\n          });\r\n\r\n          build.hooks.compile.tap(PLUGIN_NAME, (compile: ICompileSubstage) => {\r\n            compile.hooks.afterCompile.tap(PLUGIN_NAME, this._compileHooks_afterEachCompile);\r\n            compile.hooks.afterRecompile.tap(PLUGIN_NAME, this._compileHooks_afterEachCompile);\r\n          });\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private async _loadStageConfiguration(heftConfiguration: HeftConfiguration): Promise<void> {\r\n    this._rawConfiguration =\r\n      await CoreConfigFiles.nodeServiceConfigurationLoader.tryLoadConfigurationFileForProjectAsync(\r\n        this._logger.terminal,\r\n        heftConfiguration.buildFolder,\r\n        heftConfiguration.rigConfig\r\n      );\r\n\r\n    // defaults\r\n    this._configuration = {\r\n      commandName: 'serve',\r\n      ignoreMissingScript: false,\r\n      waitBeforeRestartMs: 2000,\r\n      waitForTerminateMs: 2000,\r\n      waitForKillMs: 2000\r\n    };\r\n\r\n    // TODO: @rushstack/heft-config-file should be able to read a *.defaults.json file\r\n    if (this._rawConfiguration) {\r\n      this._pluginEnabled = true;\r\n\r\n      if (this._rawConfiguration.commandName !== undefined) {\r\n        this._configuration.commandName = this._rawConfiguration.commandName;\r\n      }\r\n      if (this._rawConfiguration.ignoreMissingScript !== undefined) {\r\n        this._configuration.ignoreMissingScript = this._rawConfiguration.ignoreMissingScript;\r\n      }\r\n      if (this._rawConfiguration.waitBeforeRestartMs !== undefined) {\r\n        this._configuration.waitBeforeRestartMs = this._rawConfiguration.waitBeforeRestartMs;\r\n      }\r\n      if (this._rawConfiguration.waitForTerminateMs !== undefined) {\r\n        this._configuration.waitForTerminateMs = this._rawConfiguration.waitForTerminateMs;\r\n      }\r\n      if (this._rawConfiguration.waitForKillMs !== undefined) {\r\n        this._configuration.waitForKillMs = this._rawConfiguration.waitForKillMs;\r\n      }\r\n\r\n      this._shellCommand = (heftConfiguration.projectPackageJson.scripts || {})[\r\n        this._configuration.commandName\r\n      ];\r\n\r\n      if (this._shellCommand === undefined) {\r\n        if (this._configuration.ignoreMissingScript) {\r\n          this._logger.terminal.writeLine(\r\n            `The plugin is disabled because the project's package.json` +\r\n              ` does not have a \"${this._configuration.commandName}\" script`\r\n          );\r\n        } else {\r\n          throw new Error(\r\n            `The node-service task cannot start because the project's package.json ` +\r\n              `does not have a \"${this._configuration.commandName}\" script`\r\n          );\r\n        }\r\n        this._pluginEnabled = false;\r\n      }\r\n    } else {\r\n      this._logger.terminal.writeVerboseLine(\r\n        'The plugin is disabled because its config file was not found: ' +\r\n          CoreConfigFiles.nodeServiceConfigurationLoader.projectRelativeFilePath\r\n      );\r\n    }\r\n  }\r\n\r\n  private async _runCommandAsync(\r\n    heftSession: HeftSession,\r\n    heftConfiguration: HeftConfiguration\r\n  ): Promise<void> {\r\n    this._logger.terminal.writeLine(`Starting Node service...`);\r\n\r\n    this._restartChild();\r\n  }\r\n\r\n  private _compileHooks_afterEachCompile = (): void => {\r\n    this._trapUnhandledException(() => {\r\n      // We've recompiled, so try launching again\r\n      this._childProcessFailed = false;\r\n\r\n      if (this._state === State.Stopped) {\r\n        // If we are already stopped, then extend the timeout\r\n        this._scheduleRestart(this._configuration.waitBeforeRestartMs);\r\n      } else {\r\n        this._stopChild();\r\n      }\r\n    });\r\n  };\r\n\r\n  private _restartChild(): void {\r\n    if (this._state !== State.Stopped) {\r\n      throw new InternalError('Invalid state');\r\n    }\r\n\r\n    this._state = State.Running;\r\n    this._clearTimeout();\r\n\r\n    this._logger.terminal.writeLine('Invoking command: ' + JSON.stringify(this._shellCommand!));\r\n\r\n    this._activeChildProcess = child_process.spawn(this._shellCommand!, {\r\n      shell: true,\r\n      stdio: ['inherit', 'inherit', 'inherit'],\r\n      ...SubprocessTerminator.RECOMMENDED_OPTIONS\r\n    });\r\n    SubprocessTerminator.killProcessTreeOnExit(\r\n      this._activeChildProcess,\r\n      SubprocessTerminator.RECOMMENDED_OPTIONS\r\n    );\r\n\r\n    const childPid: number = this._activeChildProcess.pid;\r\n    this._logger.terminal.writeVerboseLine(`Started service process #${childPid}`);\r\n\r\n    this._activeChildProcess.on('close', (code: number, signal: string): void => {\r\n      this._trapUnhandledException(() => {\r\n        // The 'close' event is emitted after a process has ended and the stdio streams of a child process\r\n        // have been closed. This is distinct from the 'exit' event, since multiple processes might share the\r\n        // same stdio streams. The 'close' event will always emit after 'exit' was already emitted,\r\n        // or 'error' if the child failed to spawn.\r\n\r\n        if (this._state === State.Running) {\r\n          this._logger.terminal.writeWarningLine(\r\n            `The service process #${childPid} terminated unexpectedly` +\r\n              this._formatCodeOrSignal(code, signal)\r\n          );\r\n          this._childProcessFailed = true;\r\n          this._transitionToStopped();\r\n          return;\r\n        }\r\n\r\n        if (this._state === State.Stopping || this._state === State.Killing) {\r\n          this._logger.terminal.writeVerboseLine(\r\n            `The service process #${childPid} terminated successfully` +\r\n              this._formatCodeOrSignal(code, signal)\r\n          );\r\n          this._transitionToStopped();\r\n          return;\r\n        }\r\n      });\r\n    });\r\n\r\n    // This is event only fires for Node.js >= 15.x\r\n    this._activeChildProcess.on('spawn', () => {\r\n      this._trapUnhandledException(() => {\r\n        // Print a newline to separate the service's STDOUT from Heft's output\r\n        console.log();\r\n      });\r\n    });\r\n\r\n    this._activeChildProcess.on('exit', (code: number | null, signal: string | null) => {\r\n      this._trapUnhandledException(() => {\r\n        this._logger.terminal.writeVerboseLine(\r\n          `The service process fired its \"exit\" event` + this._formatCodeOrSignal(code, signal)\r\n        );\r\n      });\r\n    });\r\n\r\n    this._activeChildProcess.on('error', (err: Error) => {\r\n      this._trapUnhandledException(() => {\r\n        // \"The 'error' event is emitted whenever:\r\n        // 1. The process could not be spawned, or\r\n        // 2. The process could not be killed, or\r\n        // 3. Sending a message to the child process failed.\r\n        //\r\n        // The 'exit' event may or may not fire after an error has occurred. When listening to both the 'exit'\r\n        // and 'error' events, guard against accidentally invoking handler functions multiple times.\"\r\n\r\n        if (this._state === State.Running) {\r\n          this._logger.terminal.writeErrorLine(`Failed to start: ` + err.toString());\r\n          this._childProcessFailed = true;\r\n          this._transitionToStopped();\r\n          return;\r\n        }\r\n\r\n        if (this._state === State.Stopping) {\r\n          this._logger.terminal.writeWarningLine(\r\n            `The service process #${childPid} rejected the shutdown signal: ` + err.toString()\r\n          );\r\n          this._transitionToKilling();\r\n          return;\r\n        }\r\n\r\n        if (this._state === State.Killing) {\r\n          this._logger.terminal.writeErrorLine(\r\n            `The service process #${childPid} could not be killed: ` + err.toString()\r\n          );\r\n          this._transitionToStopped();\r\n          return;\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private _formatCodeOrSignal(code: number | null | undefined, signal: string | null | undefined): string {\r\n    if (signal) {\r\n      return ` (signal=${code})`;\r\n    }\r\n    if (typeof code === 'number') {\r\n      return ` (exit code ${code})`;\r\n    }\r\n    return '';\r\n  }\r\n\r\n  private _stopChild(): void {\r\n    if (this._state !== State.Running) {\r\n      return;\r\n    }\r\n\r\n    if (NodeServicePlugin._isWindows) {\r\n      // On Windows, SIGTERM can kill Cmd.exe and leave its children running in the background\r\n      this._transitionToKilling();\r\n    } else {\r\n      if (!this._activeChildProcess) {\r\n        // All the code paths that set _activeChildProcess=undefined should also leave the Running state\r\n        throw new InternalError('_activeChildProcess should not be undefined');\r\n      }\r\n\r\n      this._state = State.Stopping;\r\n      this._clearTimeout();\r\n\r\n      this._logger.terminal.writeVerboseLine('Sending SIGTERM to gracefully shut down the service process');\r\n\r\n      // Passing a negative PID terminates the entire group instead of just the one process.\r\n      // This works because we set detached=true for child_process.spawn()\r\n      process.kill(-this._activeChildProcess.pid, 'SIGTERM');\r\n\r\n      this._clearTimeout();\r\n      this._timeout = setTimeout(() => {\r\n        this._timeout = undefined;\r\n        this._logger.terminal.writeWarningLine('The service process is taking too long to terminate');\r\n        this._transitionToKilling();\r\n      }, this._configuration.waitForTerminateMs);\r\n    }\r\n  }\r\n\r\n  private _transitionToKilling(): void {\r\n    this._state = State.Killing;\r\n    this._clearTimeout();\r\n\r\n    if (!this._activeChildProcess) {\r\n      // All the code paths that set _activeChildProcess=undefined should also leave the Running state\r\n      throw new InternalError('_activeChildProcess should not be undefined');\r\n    }\r\n\r\n    this._logger.terminal.writeVerboseLine('Attempting to killing the service process');\r\n\r\n    SubprocessTerminator.killProcessTree(this._activeChildProcess, SubprocessTerminator.RECOMMENDED_OPTIONS);\r\n\r\n    this._clearTimeout();\r\n    this._timeout = setTimeout(() => {\r\n      this._timeout = undefined;\r\n      this._logger.terminal.writeErrorLine('Abandoning the service process because it could not be killed');\r\n      this._transitionToStopped();\r\n    }, this._configuration.waitForKillMs);\r\n  }\r\n\r\n  private _transitionToStopped(): void {\r\n    // Failed to start\r\n    this._state = State.Stopped;\r\n    this._clearTimeout();\r\n\r\n    this._activeChildProcess = undefined;\r\n\r\n    // Once we have stopped, schedule a restart\r\n    if (!this._childProcessFailed) {\r\n      this._scheduleRestart(this._configuration.waitBeforeRestartMs);\r\n    } else {\r\n      this._logger.terminal.writeLine(\r\n        'The service process has failed.  Waiting for watch mode to recompile before restarting...'\r\n      );\r\n    }\r\n  }\r\n\r\n  private _scheduleRestart(msFromNow: number): void {\r\n    const newTime: number = performance.now() + msFromNow;\r\n    if (this._restartTime !== undefined && newTime < this._restartTime) {\r\n      return;\r\n    }\r\n\r\n    this._restartTime = newTime;\r\n    this._logger.terminal.writeVerboseLine(`Sleeping for ${msFromNow} milliseconds`);\r\n\r\n    this._clearTimeout();\r\n    this._timeout = setTimeout(() => {\r\n      this._timeout = undefined;\r\n      this._restartTime = undefined;\r\n\r\n      this._logger.terminal.writeVerboseLine('Time to restart');\r\n      this._restartChild();\r\n    }, Math.max(0, this._restartTime - performance.now()));\r\n  }\r\n\r\n  private _clearTimeout(): void {\r\n    if (this._timeout) {\r\n      clearTimeout(this._timeout);\r\n      this._timeout = undefined;\r\n    }\r\n  }\r\n\r\n  private _trapUnhandledException(action: () => void): void {\r\n    try {\r\n      action();\r\n    } catch (error) {\r\n      this._logger.emitError(error);\r\n      this._logger.terminal.writeErrorLine('An unexpected error occurred');\r\n\r\n      // TODO: Provide a Heft facility for this\r\n      process.exit(1);\r\n    }\r\n  }\r\n}\r\n"]}