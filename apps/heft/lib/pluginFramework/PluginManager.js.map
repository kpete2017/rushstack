{"version":3,"file":"PluginManager.js","sourceRoot":"","sources":["../../src/pluginFramework/PluginManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport { Terminal, InternalError, Import } from '@rushstack/node-core-library';\r\n\r\nimport { HeftConfiguration } from '../configuration/HeftConfiguration';\r\nimport { IHeftPlugin } from './IHeftPlugin';\r\nimport { InternalHeftSession } from './InternalHeftSession';\r\nimport { HeftSession } from './HeftSession';\r\nimport {\r\n  CoreConfigFiles,\r\n  IHeftConfigurationJsonPluginSpecifier,\r\n  IHeftConfigurationJson\r\n} from '../utilities/CoreConfigFiles';\r\n\r\n// Default plugins\r\nimport { CopyFilesPlugin } from '../plugins/CopyFilesPlugin';\r\nimport { TypeScriptPlugin } from '../plugins/TypeScriptPlugin/TypeScriptPlugin';\r\nimport { DeleteGlobsPlugin } from '../plugins/DeleteGlobsPlugin';\r\nimport { CopyStaticAssetsPlugin } from '../plugins/CopyStaticAssetsPlugin';\r\nimport { RunScriptPlugin } from '../plugins/RunScriptPlugin';\r\nimport { ApiExtractorPlugin } from '../plugins/ApiExtractorPlugin/ApiExtractorPlugin';\r\nimport { SassTypingsPlugin } from '../plugins/SassTypingsPlugin/SassTypingsPlugin';\r\nimport { ProjectValidatorPlugin } from '../plugins/ProjectValidatorPlugin';\r\nimport { ToolPackageResolver } from '../utilities/ToolPackageResolver';\r\nimport { NodeServicePlugin } from '../plugins/NodeServicePlugin';\r\n\r\nexport interface IPluginManagerOptions {\r\n  terminal: Terminal;\r\n  heftConfiguration: HeftConfiguration;\r\n  internalHeftSession: InternalHeftSession;\r\n}\r\n\r\nexport class PluginManager {\r\n  private _terminal: Terminal;\r\n  private _heftConfiguration: HeftConfiguration;\r\n  private _internalHeftSession: InternalHeftSession;\r\n  private _appliedPlugins: IHeftPlugin[] = [];\r\n  private _appliedPluginNames: Set<string> = new Set<string>();\r\n\r\n  public constructor(options: IPluginManagerOptions) {\r\n    this._terminal = options.terminal;\r\n    this._heftConfiguration = options.heftConfiguration;\r\n    this._internalHeftSession = options.internalHeftSession;\r\n  }\r\n\r\n  public initializeDefaultPlugins(): void {\r\n    const taskPackageResolver: ToolPackageResolver = new ToolPackageResolver();\r\n\r\n    this._applyPlugin(new TypeScriptPlugin(taskPackageResolver));\r\n    this._applyPlugin(new CopyStaticAssetsPlugin());\r\n    this._applyPlugin(new CopyFilesPlugin());\r\n    this._applyPlugin(new DeleteGlobsPlugin());\r\n    this._applyPlugin(new RunScriptPlugin());\r\n    this._applyPlugin(new ApiExtractorPlugin(taskPackageResolver));\r\n    this._applyPlugin(new SassTypingsPlugin());\r\n    this._applyPlugin(new ProjectValidatorPlugin());\r\n    this._applyPlugin(new NodeServicePlugin());\r\n  }\r\n\r\n  public initializePlugin(pluginSpecifier: string, options?: object): void {\r\n    const resolvedPluginPath: string = this._resolvePlugin(pluginSpecifier);\r\n    this._initializeResolvedPlugin(resolvedPluginPath, options);\r\n  }\r\n\r\n  public async initializePluginsFromConfigFileAsync(): Promise<void> {\r\n    const heftConfigurationJson: IHeftConfigurationJson | undefined =\r\n      await CoreConfigFiles.heftConfigFileLoader.tryLoadConfigurationFileForProjectAsync(\r\n        this._heftConfiguration.globalTerminal,\r\n        this._heftConfiguration.buildFolder,\r\n        this._heftConfiguration.rigConfig\r\n      );\r\n    const heftPluginSpecifiers: IHeftConfigurationJsonPluginSpecifier[] =\r\n      heftConfigurationJson?.heftPlugins || [];\r\n\r\n    for (const pluginSpecifier of heftPluginSpecifiers) {\r\n      this._initializeResolvedPlugin(pluginSpecifier.plugin, pluginSpecifier.options);\r\n    }\r\n  }\r\n\r\n  public afterInitializeAllPlugins(): void {\r\n    for (const appliedPlugin of this._appliedPlugins) {\r\n      this._internalHeftSession.applyPluginHooks(appliedPlugin);\r\n    }\r\n  }\r\n\r\n  private _initializeResolvedPlugin(resolvedPluginPath: string, options?: object): void {\r\n    const plugin: IHeftPlugin<object | void> = this._loadAndValidatePluginPackage(\r\n      resolvedPluginPath,\r\n      options\r\n    );\r\n\r\n    if (this._appliedPluginNames.has(plugin.pluginName)) {\r\n      throw new Error(\r\n        `Error applying plugin \"${resolvedPluginPath}\": A plugin with name \"${plugin.pluginName}\" has ` +\r\n          'already been applied'\r\n      );\r\n    } else {\r\n      this._applyPlugin(plugin, options);\r\n    }\r\n  }\r\n\r\n  private _applyPlugin(plugin: IHeftPlugin<object | void>, options?: object): void {\r\n    try {\r\n      const heftSession: HeftSession = this._internalHeftSession.getSessionForPlugin(plugin);\r\n      plugin.apply(heftSession, this._heftConfiguration, options);\r\n      this._appliedPlugins.push(plugin);\r\n      this._appliedPluginNames.add(plugin.pluginName);\r\n    } catch (e) {\r\n      throw new InternalError(`Error applying \"${plugin.pluginName}\": ${e}`);\r\n    }\r\n  }\r\n\r\n  private _loadAndValidatePluginPackage(resolvedPluginPath: string, options?: object): IHeftPlugin {\r\n    let pluginPackage: IHeftPlugin;\r\n    try {\r\n      // eslint-disable-next-line @typescript-eslint/no-var-requires\r\n      const loadedPluginPackage: IHeftPlugin | { default: IHeftPlugin } = require(resolvedPluginPath);\r\n      pluginPackage = (loadedPluginPackage as { default: IHeftPlugin }).default || loadedPluginPackage;\r\n    } catch (e) {\r\n      throw new InternalError(`Error loading plugin package from \"${resolvedPluginPath}\": ${e}`);\r\n    }\r\n\r\n    if (!pluginPackage) {\r\n      throw new InternalError(`Plugin package loaded from \"${resolvedPluginPath}\" is null or undefined.`);\r\n    }\r\n\r\n    this._terminal.writeVerboseLine(`Loaded plugin package from \"${resolvedPluginPath}\"`);\r\n\r\n    if (!pluginPackage.apply || typeof pluginPackage.apply !== 'function') {\r\n      throw new InternalError(\r\n        `Plugin packages must define an \"apply\" function. The plugin loaded from \"${resolvedPluginPath}\" ` +\r\n          'either doesn\\'t define an \"apply\" property, or its value isn\\'t a function.'\r\n      );\r\n    }\r\n\r\n    if (!pluginPackage.pluginName || typeof pluginPackage.pluginName !== 'string') {\r\n      throw new InternalError(\r\n        `Plugin packages must define a \"pluginName\" property. The plugin loaded from \"${resolvedPluginPath}\" ` +\r\n          'either doesn\\'t define a \"pluginName\" property, or its value isn\\'t a string.'\r\n      );\r\n    }\r\n\r\n    if (options && pluginPackage.optionsSchema) {\r\n      try {\r\n        pluginPackage.optionsSchema.validateObject(options, 'config/heft.json');\r\n      } catch (e) {\r\n        throw new Error(\r\n          `Provided options for plugin \"${pluginPackage.pluginName}\" did not match the provided plugin schema.\\n${e}`\r\n        );\r\n      }\r\n    }\r\n\r\n    return pluginPackage;\r\n  }\r\n\r\n  private _resolvePlugin(pluginSpecifier: string): string {\r\n    let resolvedPluginPath: string;\r\n\r\n    this._terminal.writeVerboseLine(`Resolving plugin ${pluginSpecifier}`);\r\n\r\n    try {\r\n      resolvedPluginPath = Import.resolveModule({\r\n        modulePath: pluginSpecifier,\r\n        baseFolderPath: this._heftConfiguration.buildFolder\r\n      });\r\n    } catch (e) {\r\n      throw new InternalError(`Error resolving specified plugin \"${pluginSpecifier}\". Resolve error: ${e}`);\r\n    }\r\n\r\n    if (!resolvedPluginPath) {\r\n      throw new InternalError(`Error resolving specified plugin \"${pluginSpecifier}\".`);\r\n    }\r\n\r\n    this._terminal.writeVerboseLine(`Resolved plugin path to ${resolvedPluginPath}`);\r\n\r\n    return resolvedPluginPath;\r\n  }\r\n}\r\n"]}