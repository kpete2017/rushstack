{"version":3,"file":"CleanStage.js","sourceRoot":"","sources":["../../src/stages/CleanStage.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;;AAE3D,qCAA4C;AAC5C,oEAA0D;AAE1D,2CAAuE;AAIvE;;GAEG;AACH,MAAa,eAAgB,SAAQ,0BAAqC;IAA1E;;QACkB,QAAG,GAAsB,IAAI,2BAAiB,EAAE,CAAC;IACnE,CAAC;CAAA;AAFD,0CAEC;AAmBD,MAAa,UAAW,SAAQ,qBAAqE;IACnG,YAAmB,iBAAoC,EAAE,cAA8B;QACrF,KAAK,CAAC,iBAAiB,EAAE,cAAc,EAAE,eAAe,CAAC,CAAC;IAC5D,CAAC;IAES,KAAK,CAAC,8BAA8B,CAC5C,OAA2B;QAE3B,qCACE,WAAW,EAAE,KAAK,IACf,OAAO,KACV,aAAa,EAAE,IAAI,GAAG,EAAU,IAChC;IACJ,CAAC;IAES,KAAK,CAAC,iBAAiB;QAC/B,MAAM,QAAQ,GAAoB,EAAE,CAAC;QAErC,IAAI,IAAI,CAAC,eAAe,CAAC,WAAW,EAAE;YACpC,QAAQ,CAAC,IAAI,CAAC,8BAAU,CAAC,iBAAiB,CAAC,IAAI,CAAC,iBAAiB,CAAC,gBAAgB,CAAC,CAAC,CAAC;SACtF;QAED,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC,CAAC;QAE7C,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;IAC9B,CAAC;CACF;AA1BD,gCA0BC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport { AsyncParallelHook } from 'tapable';\r\nimport { FileSystem } from '@rushstack/node-core-library';\r\n\r\nimport { StageBase, StageHooksBase, IStageContext } from './StageBase';\r\nimport { HeftConfiguration } from '../configuration/HeftConfiguration';\r\nimport { LoggingManager } from '../pluginFramework/logging/LoggingManager';\r\n\r\n/**\r\n * @public\r\n */\r\nexport class CleanStageHooks extends StageHooksBase<ICleanStageProperties> {\r\n  public readonly run: AsyncParallelHook = new AsyncParallelHook();\r\n}\r\n\r\n/**\r\n * @public\r\n */\r\nexport interface ICleanStageProperties {\r\n  deleteCache: boolean;\r\n  pathsToDelete: Set<string>;\r\n}\r\n\r\nexport interface ICleanStageOptions {\r\n  deleteCache?: boolean;\r\n}\r\n\r\n/**\r\n * @public\r\n */\r\nexport interface ICleanStageContext extends IStageContext<CleanStageHooks, ICleanStageProperties> {}\r\n\r\nexport class CleanStage extends StageBase<CleanStageHooks, ICleanStageProperties, ICleanStageOptions> {\r\n  public constructor(heftConfiguration: HeftConfiguration, loggingManager: LoggingManager) {\r\n    super(heftConfiguration, loggingManager, CleanStageHooks);\r\n  }\r\n\r\n  protected async getDefaultStagePropertiesAsync(\r\n    options: ICleanStageOptions\r\n  ): Promise<ICleanStageProperties> {\r\n    return {\r\n      deleteCache: false,\r\n      ...options,\r\n      pathsToDelete: new Set<string>()\r\n    };\r\n  }\r\n\r\n  protected async executeInnerAsync(): Promise<void> {\r\n    const promises: Promise<void>[] = [];\r\n\r\n    if (this.stageProperties.deleteCache) {\r\n      promises.push(FileSystem.deleteFolderAsync(this.heftConfiguration.buildCacheFolder));\r\n    }\r\n\r\n    promises.push(this.stageHooks.run.promise());\r\n\r\n    await Promise.all(promises);\r\n  }\r\n}\r\n"]}