{"version":3,"file":"StageBase.js","sourceRoot":"","sources":["../../src/stages/StageBase.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;;AAG3D,qCAAyE;AAezE;;GAEG;AACH,MAAsB,cAAc;IAApC;QACE;;;;;WAKG;QACa,kBAAa,GAA0C,IAAI,6BAAmB,CAAC;YAC7F,iBAAiB;SAClB,CAAC,CAAC;QAEa,2BAAsB,GAAoB,IAAI,yBAAe,EAAE,CAAC;QAEhE,gCAA2B,GAAoB,IAAI,yBAAe,EAAE,CAAC;IACvF,CAAC;CAAA;AAdD,wCAcC;AAED,MAAsB,SAAS;IAc7B,YACE,iBAAoC,EACpC,cAA8B,EAC9B,cAAqC;QAErC,IAAI,CAAC,iBAAiB,GAAG,iBAAiB,CAAC;QAC3C,IAAI,CAAC,cAAc,GAAG,cAAc,CAAC;QACrC,IAAI,CAAC,cAAc,GAAG,iBAAiB,CAAC,cAAc,CAAC;QACvD,IAAI,CAAC,uBAAuB,GAAG,IAAI,kBAAQ,CAA+C;YACxF,cAAc;SACf,CAAC,CAAC;QACH,IAAI,CAAC,eAAe,GAAG,cAAc,CAAC;IACxC,CAAC;IAEM,KAAK,CAAC,eAAe,CAAC,YAA2B;QACtD,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;QACjC,IAAI,CAAC,eAAe,GAAG,MAAM,IAAI,CAAC,8BAA8B,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QACpF,IAAI,CAAC,UAAU,GAAG,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;QAC7C,MAAM,YAAY,GAAiD;YACjE,KAAK,EAAE,IAAI,CAAC,UAAU;YACtB,UAAU,EAAE,IAAI,CAAC,eAAe;SACjC,CAAC;QAEF,IAAI,CAAC,uBAAuB,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QAEhD,MAAM,IAAI,CAAC,UAAU,CAAC,sBAAsB,CAAC,OAAO,EAAE,CAAC;QACvD,MAAM,IAAI,CAAC,UAAU,CAAC,2BAA2B,CAAC,OAAO,EAAE,CAAC;IAC9D,CAAC;IAEM,KAAK,CAAC,YAAY;QACvB,IAAI,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,MAAM,EAAE,EAAE;YAC1C,MAAM,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;SACnE;aAAM;YACL,MAAM,IAAI,CAAC,iBAAiB,EAAE,CAAC;SAChC;IACH,CAAC;CAKF;AAtDD,8BAsDC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport { Terminal } from '@rushstack/node-core-library';\r\nimport { AsyncSeriesBailHook, SyncHook, AsyncSeriesHook } from 'tapable';\r\nimport { HeftConfiguration } from '../configuration/HeftConfiguration';\r\nimport { LoggingManager } from '../pluginFramework/logging/LoggingManager';\r\n\r\n/**\r\n * @public\r\n */\r\nexport interface IStageContext<\r\n  TStageHooks extends StageHooksBase<TStageProperties>,\r\n  TStageProperties extends object\r\n> {\r\n  hooks: TStageHooks;\r\n  properties: TStageProperties;\r\n}\r\n\r\n/**\r\n * @public\r\n */\r\nexport abstract class StageHooksBase<TStageProperties extends object> {\r\n  /**\r\n   * This hook allows the stage's execution to be completely overridden. Only the last-registered plugin\r\n   * with an override hook provided applies.\r\n   *\r\n   * @beta\r\n   */\r\n  public readonly overrideStage: AsyncSeriesBailHook<TStageProperties> = new AsyncSeriesBailHook([\r\n    'stageProperties'\r\n  ]);\r\n\r\n  public readonly loadStageConfiguration: AsyncSeriesHook = new AsyncSeriesHook();\r\n\r\n  public readonly afterLoadStageConfiguration: AsyncSeriesHook = new AsyncSeriesHook();\r\n}\r\n\r\nexport abstract class StageBase<\r\n  TStageHooks extends StageHooksBase<TStageProperties>,\r\n  TStageProperties extends object,\r\n  TStageOptions\r\n> {\r\n  public readonly stageInitializationHook: SyncHook<IStageContext<TStageHooks, TStageProperties>>;\r\n  protected readonly heftConfiguration: HeftConfiguration;\r\n  protected readonly loggingManager: LoggingManager;\r\n  protected readonly globalTerminal: Terminal;\r\n  protected stageOptions!: TStageOptions;\r\n  protected stageProperties!: TStageProperties;\r\n  protected stageHooks!: TStageHooks;\r\n  private readonly _innerHooksType: new () => TStageHooks;\r\n\r\n  public constructor(\r\n    heftConfiguration: HeftConfiguration,\r\n    loggingManager: LoggingManager,\r\n    innerHooksType: new () => TStageHooks\r\n  ) {\r\n    this.heftConfiguration = heftConfiguration;\r\n    this.loggingManager = loggingManager;\r\n    this.globalTerminal = heftConfiguration.globalTerminal;\r\n    this.stageInitializationHook = new SyncHook<IStageContext<TStageHooks, TStageProperties>>([\r\n      'stageContext'\r\n    ]);\r\n    this._innerHooksType = innerHooksType;\r\n  }\r\n\r\n  public async initializeAsync(stageOptions: TStageOptions): Promise<void> {\r\n    this.stageOptions = stageOptions;\r\n    this.stageProperties = await this.getDefaultStagePropertiesAsync(this.stageOptions);\r\n    this.stageHooks = new this._innerHooksType();\r\n    const stageContext: IStageContext<TStageHooks, TStageProperties> = {\r\n      hooks: this.stageHooks,\r\n      properties: this.stageProperties\r\n    };\r\n\r\n    this.stageInitializationHook.call(stageContext);\r\n\r\n    await this.stageHooks.loadStageConfiguration.promise();\r\n    await this.stageHooks.afterLoadStageConfiguration.promise();\r\n  }\r\n\r\n  public async executeAsync(): Promise<void> {\r\n    if (this.stageHooks.overrideStage.isUsed()) {\r\n      await this.stageHooks.overrideStage.promise(this.stageProperties);\r\n    } else {\r\n      await this.executeInnerAsync();\r\n    }\r\n  }\r\n\r\n  protected abstract getDefaultStagePropertiesAsync(options: TStageOptions): Promise<TStageProperties>;\r\n\r\n  protected abstract executeInnerAsync(): Promise<void>;\r\n}\r\n"]}