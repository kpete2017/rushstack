{"version":3,"file":"ChangeFiles.test.js","sourceRoot":"","sources":["../../../src/logic/test/ChangeFiles.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\nimport { Path } from '@rushstack/node-core-library';\r\n\r\nimport { IChangelog } from '../../api/Changelog';\r\nimport { ChangeFiles } from '../ChangeFiles';\r\nimport { RushConfiguration } from '../../api/RushConfiguration';\r\n\r\ndescribe('ChangeFiles', () => {\r\n  let rushConfiguration: RushConfiguration;\r\n\r\n  beforeEach(() => {\r\n    rushConfiguration = {} as RushConfiguration;\r\n  });\r\n\r\n  describe('getFiles', () => {\r\n    it('returns correctly when there is one change file', () => {\r\n      const changesPath: string = path.join(__dirname, 'leafChange');\r\n      const changeFiles: ChangeFiles = new ChangeFiles(changesPath);\r\n      const expectedPath: string = Path.convertToSlashes(path.join(changesPath, 'change1.json'));\r\n      expect(changeFiles.getFiles()).toEqual([expectedPath]);\r\n    });\r\n\r\n    it('returns empty array when no change files', () => {\r\n      const changesPath: string = path.join(__dirname, 'noChange');\r\n      const changeFiles: ChangeFiles = new ChangeFiles(changesPath);\r\n      expect(changeFiles.getFiles()).toHaveLength(0);\r\n    });\r\n\r\n    it('returns correctly when change files are categorized', () => {\r\n      const changesPath: string = path.join(__dirname, 'categorizedChanges');\r\n      const changeFiles: ChangeFiles = new ChangeFiles(changesPath);\r\n      const files: string[] = changeFiles.getFiles();\r\n      expect(files).toHaveLength(3);\r\n\r\n      const expectedPathA: string = Path.convertToSlashes(path.join(changesPath, '@ms', 'a', 'changeA.json'));\r\n      const expectedPathB: string = Path.convertToSlashes(path.join(changesPath, '@ms', 'b', 'changeB.json'));\r\n      const expectedPathC: string = Path.convertToSlashes(path.join(changesPath, 'changeC.json'));\r\n      expect(files).toContain(expectedPathA);\r\n      expect(files).toContain(expectedPathB);\r\n      expect(files).toContain(expectedPathC);\r\n    });\r\n  });\r\n\r\n  describe('validate', () => {\r\n    it('throws when there is a patch in a hotfix branch.', () => {\r\n      const changeFile: string = path.join(__dirname, 'leafChange', 'change1.json');\r\n      const changedPackages: string[] = ['d'];\r\n      expect(() => {\r\n        ChangeFiles.validate([changeFile], changedPackages, {\r\n          hotfixChangeEnabled: true\r\n        } as RushConfiguration);\r\n      }).toThrow(Error);\r\n    });\r\n\r\n    it('allows a hotfix in a hotfix branch.', () => {\r\n      const changeFile: string = path.join(__dirname, 'multipleHotfixChanges', 'change1.json');\r\n      const changedPackages: string[] = ['a'];\r\n      ChangeFiles.validate([changeFile], changedPackages, { hotfixChangeEnabled: true } as RushConfiguration);\r\n    });\r\n\r\n    it('throws when there is any missing package.', () => {\r\n      const changeFile: string = path.join(__dirname, 'verifyChanges', 'changes.json');\r\n      const changedPackages: string[] = ['a', 'b', 'c'];\r\n      expect(() => {\r\n        ChangeFiles.validate([changeFile], changedPackages, rushConfiguration);\r\n      }).toThrow(Error);\r\n    });\r\n\r\n    it('does not throw when there is no missing packages', () => {\r\n      const changeFile: string = path.join(__dirname, 'verifyChanges', 'changes.json');\r\n      const changedPackages: string[] = ['a'];\r\n      expect(() => {\r\n        ChangeFiles.validate([changeFile], changedPackages, rushConfiguration);\r\n      }).not.toThrow();\r\n    });\r\n\r\n    it('throws when missing packages from categorized changes', () => {\r\n      const changeFileA: string = path.join(__dirname, 'categorizedChanges', '@ms', 'a', 'changeA.json');\r\n      const changeFileB: string = path.join(__dirname, 'categorizedChanges', '@ms', 'b', 'changeB.json');\r\n      const changedPackages: string[] = ['@ms/a', '@ms/b', 'c'];\r\n      expect(() => {\r\n        ChangeFiles.validate([changeFileA, changeFileB], changedPackages, rushConfiguration);\r\n      }).toThrow(Error);\r\n    });\r\n\r\n    it('does not throw when no missing packages from categorized changes', () => {\r\n      const changeFileA: string = path.join(__dirname, 'categorizedChanges', '@ms', 'a', 'changeA.json');\r\n      const changeFileB: string = path.join(__dirname, 'categorizedChanges', '@ms', 'b', 'changeB.json');\r\n      const changeFileC: string = path.join(__dirname, 'categorizedChanges', 'changeC.json');\r\n      const changedPackages: string[] = ['@ms/a', '@ms/b', 'c'];\r\n      expect(() => {\r\n        ChangeFiles.validate([changeFileA, changeFileB, changeFileC], changedPackages, rushConfiguration);\r\n      }).not.toThrow(Error);\r\n    });\r\n  });\r\n\r\n  describe('deleteAll', () => {\r\n    it('delete all files when there are no prerelease packages', () => {\r\n      const changesPath: string = path.join(__dirname, 'multipleChangeFiles');\r\n      const changeFiles: ChangeFiles = new ChangeFiles(changesPath);\r\n      expect(changeFiles.deleteAll(false)).toEqual(3);\r\n    });\r\n\r\n    it('does not delete change files for package whose change logs do not get updated. ', () => {\r\n      const changesPath: string = path.join(__dirname, 'multipleChangeFiles');\r\n      const changeFiles: ChangeFiles = new ChangeFiles(changesPath);\r\n      const updatedChangelogs: IChangelog[] = [\r\n        {\r\n          name: 'a',\r\n          entries: []\r\n        },\r\n        {\r\n          name: 'b',\r\n          entries: []\r\n        }\r\n      ];\r\n      expect(changeFiles.deleteAll(false, updatedChangelogs)).toEqual(2);\r\n    });\r\n\r\n    it('delete all files when there are hotfixes', () => {\r\n      const changesPath: string = path.join(__dirname, 'multipleHotfixChanges');\r\n      const changeFiles: ChangeFiles = new ChangeFiles(changesPath);\r\n      expect(changeFiles.deleteAll(false)).toEqual(3);\r\n    });\r\n  });\r\n});\r\n"]}