{"version":3,"file":"PnpmfileConfiguration.js","sourceRoot":"","sources":["../../../src/logic/pnpm/PnpmfileConfiguration.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\nimport { FileSystem, IPackageJson, JsonFile, MapExtensions } from '@rushstack/node-core-library';\r\n\r\nimport { PnpmPackageManager } from '../../api/packageManager/PnpmPackageManager';\r\nimport { PnpmOptionsConfiguration, RushConfiguration } from '../../api/RushConfiguration';\r\nimport { CommonVersionsConfiguration } from '../../api/CommonVersionsConfiguration';\r\nimport * as pnpmfile from './PnpmfileShim';\r\n\r\nimport type { IPnpmfileContext, IPnpmfileShimSettings } from './IPnpmfile';\r\n\r\n/**\r\n * Options used when generating the pnpmfile shim settings file.\r\n */\r\nexport interface IPnpmfileShimOptions {\r\n  /**\r\n   * The variant that the client pnpmfile will be sourced from.\r\n   */\r\n  variant?: string;\r\n}\r\n\r\n/**\r\n * Loads PNPM's pnpmfile.js configuration, and invokes it to preprocess package.json files,\r\n * optionally utilizing a pnpmfile shim to inject preferred versions.\r\n */\r\nexport class PnpmfileConfiguration {\r\n  private _context: IPnpmfileContext | undefined;\r\n\r\n  public constructor(rushConfiguration: RushConfiguration, pnpmfileShimOptions?: IPnpmfileShimOptions) {\r\n    if (rushConfiguration.packageManager !== 'pnpm') {\r\n      throw new Error(\r\n        `PnpmfileConfiguration cannot be used with package manager \"${rushConfiguration.packageManager}\"`\r\n      );\r\n    }\r\n\r\n    // Set the context to swallow log output and store our settings\r\n    this._context = {\r\n      log: (message: string) => {},\r\n      pnpmfileShimSettings: PnpmfileConfiguration._getPnpmfileShimSettings(\r\n        rushConfiguration,\r\n        pnpmfileShimOptions\r\n      )\r\n    };\r\n  }\r\n\r\n  public static async writeCommonTempPnpmfileShimAsync(\r\n    rushConfiguration: RushConfiguration,\r\n    options?: IPnpmfileShimOptions\r\n  ): Promise<void> {\r\n    if (rushConfiguration.packageManager !== 'pnpm') {\r\n      throw new Error(\r\n        `PnpmfileConfiguration cannot be used with package manager \"${rushConfiguration.packageManager}\"`\r\n      );\r\n    }\r\n\r\n    const targetDir: string = rushConfiguration.commonTempFolder;\r\n    const pnpmfilePath: string = path.join(\r\n      targetDir,\r\n      (rushConfiguration.packageManagerWrapper as PnpmPackageManager).pnpmfileFilename\r\n    );\r\n\r\n    // Write the shim itself\r\n    await FileSystem.copyFileAsync({\r\n      sourcePath: path.join(__dirname, 'PnpmfileShim.js'),\r\n      destinationPath: pnpmfilePath\r\n    });\r\n\r\n    const pnpmfileShimSettings: IPnpmfileShimSettings = PnpmfileConfiguration._getPnpmfileShimSettings(\r\n      rushConfiguration,\r\n      options\r\n    );\r\n\r\n    // Write the settings file used by the shim\r\n    await JsonFile.saveAsync(pnpmfileShimSettings, path.join(targetDir, 'pnpmfileSettings.json'), {\r\n      ensureFolderExists: true\r\n    });\r\n  }\r\n\r\n  private static _getPnpmfileShimSettings(\r\n    rushConfiguration: RushConfiguration,\r\n    options?: IPnpmfileShimOptions\r\n  ): IPnpmfileShimSettings {\r\n    let allPreferredVersions: { [dependencyName: string]: string } = {};\r\n    let allowedAlternativeVersions: { [dependencyName: string]: readonly string[] } = {};\r\n\r\n    // Only workspaces shims in the common versions using pnpmfile\r\n    if ((rushConfiguration.packageManagerOptions as PnpmOptionsConfiguration).useWorkspaces) {\r\n      const commonVersionsConfiguration: CommonVersionsConfiguration = rushConfiguration.getCommonVersions();\r\n      const preferredVersions: Map<string, string> = new Map();\r\n      MapExtensions.mergeFromMap(preferredVersions, commonVersionsConfiguration.getAllPreferredVersions());\r\n      MapExtensions.mergeFromMap(preferredVersions, rushConfiguration.getImplicitlyPreferredVersions());\r\n      allPreferredVersions = MapExtensions.toObject(preferredVersions);\r\n      allowedAlternativeVersions = MapExtensions.toObject(\r\n        commonVersionsConfiguration.allowedAlternativeVersions\r\n      );\r\n    }\r\n\r\n    const settings: IPnpmfileShimSettings = {\r\n      allPreferredVersions,\r\n      allowedAlternativeVersions,\r\n      semverPath: require.resolve('semver')\r\n    };\r\n\r\n    // Use the provided path if available. Otherwise, use the default path.\r\n    const userPnpmfilePath: string | undefined = rushConfiguration.getPnpmfilePath(options?.variant);\r\n    if (userPnpmfilePath && FileSystem.exists(userPnpmfilePath)) {\r\n      settings.userPnpmfilePath = userPnpmfilePath;\r\n    }\r\n\r\n    return settings;\r\n  }\r\n\r\n  /**\r\n   * Transform a package.json file using the pnpmfile.js hook.\r\n   * @returns the tranformed object, or the original input if pnpmfile.js was not found.\r\n   */\r\n  public transform(packageJson: IPackageJson): IPackageJson {\r\n    if (!pnpmfile.hooks?.readPackage || !this._context) {\r\n      return packageJson;\r\n    } else {\r\n      return pnpmfile.hooks.readPackage(packageJson, this._context);\r\n    }\r\n  }\r\n}\r\n"]}