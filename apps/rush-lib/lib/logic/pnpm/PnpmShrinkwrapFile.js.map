{"version":3,"file":"PnpmShrinkwrapFile.js","sourceRoot":"","sources":["../../../src/logic/pnpm/PnpmShrinkwrapFile.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as os from 'os';\r\nimport * as path from 'path';\r\nimport * as semver from 'semver';\r\nimport crypto from 'crypto';\r\nimport colors from 'colors/safe';\r\nimport { FileSystem, AlreadyReportedError, Import, Path, IPackageJson } from '@rushstack/node-core-library';\r\n\r\nimport { BaseShrinkwrapFile } from '../base/BaseShrinkwrapFile';\r\nimport { DependencySpecifier } from '../DependencySpecifier';\r\nimport {\r\n  PackageManagerOptionsConfigurationBase,\r\n  PnpmOptionsConfiguration,\r\n  RushConfiguration\r\n} from '../../api/RushConfiguration';\r\nimport { IShrinkwrapFilePolicyValidatorOptions } from '../policy/ShrinkwrapFilePolicy';\r\nimport { PNPM_SHRINKWRAP_YAML_FORMAT } from './PnpmYamlCommon';\r\nimport { RushConstants } from '../RushConstants';\r\nimport { IExperimentsJson } from '../../api/ExperimentsConfiguration';\r\nimport { DependencyType, PackageJsonDependency, PackageJsonEditor } from '../../api/PackageJsonEditor';\r\nimport { RushConfigurationProject } from '../../api/RushConfigurationProject';\r\nimport { PnpmfileConfiguration } from './PnpmfileConfiguration';\r\nimport { PnpmProjectShrinkwrapFile } from './PnpmProjectShrinkwrapFile';\r\n\r\nconst yamlModule: typeof import('js-yaml') = Import.lazy('js-yaml', require);\r\n\r\nexport interface IPeerDependenciesMetaYaml {\r\n  optional?: boolean;\r\n}\r\n\r\nexport interface IPnpmShrinkwrapDependencyYaml {\r\n  /** Information about the resolved package */\r\n  resolution?: {\r\n    /** The hash of the tarball, to ensure archive integrity */\r\n    integrity: string;\r\n    /** The name of the tarball, if this was from a TGX file */\r\n    tarball?: string;\r\n  };\r\n  /** The list of dependencies and the resolved version */\r\n  dependencies?: { [dependency: string]: string };\r\n  /** The list of optional dependencies and the resolved version */\r\n  optionalDependencies?: { [dependency: string]: string };\r\n  /** The list of peer dependencies and the resolved version */\r\n  peerDependencies?: { [dependency: string]: string };\r\n  /**\r\n   * Used to indicate optional peer dependencies, as described in this RFC:\r\n   * https://github.com/yarnpkg/rfcs/blob/master/accepted/0000-optional-peer-dependencies.md\r\n   */\r\n  peerDependenciesMeta?: { [dependency: string]: IPeerDependenciesMetaYaml };\r\n}\r\n\r\nexport interface IPnpmShrinkwrapImporterYaml {\r\n  /** The list of resolved version numbers for direct dependencies */\r\n  dependencies?: { [dependency: string]: string };\r\n  /** The list of resolved version numbers for dev dependencies */\r\n  devDependencies?: { [dependency: string]: string };\r\n  /** The list of resolved version numbers for optional dependencies */\r\n  optionalDependencies?: { [dependency: string]: string };\r\n  /** The list of specifiers used to resolve dependency versions */\r\n  specifiers: { [dependency: string]: string };\r\n}\r\n\r\n/**\r\n * This interface represents the raw pnpm-lock.YAML file\r\n * Example:\r\n *  {\r\n *    \"dependencies\": {\r\n *      \"@rush-temp/project1\": \"file:./projects/project1.tgz\"\r\n *    },\r\n *    \"packages\": {\r\n *      \"file:projects/library1.tgz\": {\r\n *        \"dependencies: {\r\n *          \"markdown\": \"0.5.0\"\r\n *        },\r\n *        \"name\": \"@rush-temp/library1\",\r\n *        \"resolution\": {\r\n *          \"tarball\": \"file:projects/library1.tgz\"\r\n *        },\r\n *        \"version\": \"0.0.0\"\r\n *      },\r\n *      \"markdown/0.5.0\": {\r\n *        \"resolution\": {\r\n *          \"integrity\": \"sha1-KCBbVlqK51kt4gdGPWY33BgnIrI=\"\r\n *        }\r\n *      }\r\n *    },\r\n *    \"registry\": \"http://localhost:4873/\",\r\n *    \"shrinkwrapVersion\": 3,\r\n *    \"specifiers\": {\r\n *      \"@rush-temp/project1\": \"file:./projects/project1.tgz\"\r\n *    }\r\n *  }\r\n */\r\nexport interface IPnpmShrinkwrapYaml {\r\n  /** The list of resolved version numbers for direct dependencies */\r\n  dependencies: { [dependency: string]: string };\r\n  /** The list of importers for local workspace projects */\r\n  importers: { [relativePath: string]: IPnpmShrinkwrapImporterYaml };\r\n  /** The description of the solved graph */\r\n  packages: { [dependencyVersion: string]: IPnpmShrinkwrapDependencyYaml };\r\n  /** URL of the registry which was used */\r\n  registry: string;\r\n  /** The list of specifiers used to resolve direct dependency versions */\r\n  specifiers: { [dependency: string]: string };\r\n}\r\n\r\n/**\r\n * Given an encoded \"dependency key\" from the PNPM shrinkwrap file, this parses it into an equivalent\r\n * DependencySpecifier.\r\n *\r\n * @returns a SemVer string, or undefined if the version specifier cannot be parsed\r\n */\r\nexport function parsePnpmDependencyKey(\r\n  dependencyName: string,\r\n  dependencyKey: string\r\n): DependencySpecifier | undefined {\r\n  if (!dependencyKey) {\r\n    return undefined;\r\n  }\r\n\r\n  if (/^\\w+:/.test(dependencyKey)) {\r\n    // If it starts with an NPM scheme such as \"file:projects/my-app.tgz\", we don't support that\r\n    return undefined;\r\n  }\r\n\r\n  // The package name parsed from the dependency key, or dependencyName if it was omitted.\r\n  // Example: \"@scope/depame\"\r\n  let parsedPackageName: string;\r\n\r\n  // The trailing portion of the dependency key that includes the version and optional peer dependency path.\r\n  // Example: \"2.8.0/chai@3.5.0+sinon@1.17.7\"\r\n  let parsedInstallPath: string;\r\n\r\n  // Example: \"path.pkgs.visualstudio.com/@scope/depame/1.4.0\"  --> 0=\"@scope/depame\" 1=\"1.4.0\"\r\n  // Example: \"/isarray/2.0.1\"                                  --> 0=\"isarray\"       1=\"2.0.1\"\r\n  // Example: \"/sinon-chai/2.8.0/chai@3.5.0+sinon@1.17.7\"       --> 0=\"sinon-chai\"    1=\"2.8.0/chai@3.5.0+sinon@1.17.7\"\r\n  const packageNameMatch: RegExpMatchArray | null = /^[^\\/]*\\/((?:@[^\\/]+\\/)?[^\\/]+)\\/(.*)$/.exec(\r\n    dependencyKey\r\n  );\r\n  if (packageNameMatch) {\r\n    parsedPackageName = packageNameMatch[1];\r\n    parsedInstallPath = packageNameMatch[2];\r\n  } else {\r\n    parsedPackageName = dependencyName;\r\n\r\n    // Example: \"23.6.0_babel-core@6.26.3\"\r\n    // Example: \"23.6.0\"\r\n    parsedInstallPath = dependencyKey;\r\n  }\r\n\r\n  // The SemVer value\r\n  // Example: \"2.8.0\"\r\n  let parsedVersionPart: string;\r\n\r\n  // Example: \"23.6.0_babel-core@6.26.3\" --> \"23.6.0\"\r\n  // Example: \"2.8.0/chai@3.5.0+sinon@1.17.7\" --> \"2.8.0\"\r\n  const versionMatch: RegExpMatchArray | null = /^([^\\/_]+)[\\/_]/.exec(parsedInstallPath);\r\n  if (versionMatch) {\r\n    parsedVersionPart = versionMatch[1];\r\n  } else {\r\n    // Example: \"2.8.0\"\r\n    parsedVersionPart = parsedInstallPath;\r\n  }\r\n\r\n  // By this point, we expect parsedVersionPart to be a valid SemVer range\r\n  if (!parsedVersionPart) {\r\n    return undefined;\r\n  }\r\n\r\n  if (!semver.valid(parsedVersionPart)) {\r\n    const urlRegex: RegExp = /^(@?)([a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}\\/([^\\/\\\\]+\\/?)*([^\\/\\\\]+)$/i;\r\n    // Test for urls:\r\n    // Examples:\r\n    //     @github.com/abc/def/188ed64efd5218beda276e02f2277bf3a6b745b2\r\n    //     github.com/abc/def/188ed64efd5218beda276e02f2277bf3a6b745b2\r\n    //     github.com.au/abc/def/188ed64efd5218beda276e02f2277bf3a6b745b2\r\n    //     bitbucket.com/abc/def/188ed64efd5218beda276e02f2277bf3a6b745b2\r\n    //     bitbucket.co.in/abc/def/188ed64efd5218beda276e02f2277bf3a6b745b2\r\n    if (urlRegex.test(dependencyKey)) {\r\n      const dependencySpecifier: DependencySpecifier = new DependencySpecifier(dependencyName, dependencyKey);\r\n      return dependencySpecifier;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  // Is it an alias for a different package?\r\n  if (parsedPackageName === dependencyName) {\r\n    // No, it's a regular dependency\r\n    return new DependencySpecifier(parsedPackageName, parsedVersionPart);\r\n  } else {\r\n    // If the parsed package name is different from the dependencyName, then this is an NPM package alias\r\n    return new DependencySpecifier(dependencyName, `npm:${parsedPackageName}@${parsedVersionPart}`);\r\n  }\r\n}\r\n\r\nexport class PnpmShrinkwrapFile extends BaseShrinkwrapFile {\r\n  public readonly shrinkwrapFilename: string;\r\n  public readonly isWorkspaceCompatible: boolean;\r\n  public readonly registry: string;\r\n  public readonly dependencies: ReadonlyMap<string, string>;\r\n  public readonly importers: ReadonlyMap<string, IPnpmShrinkwrapImporterYaml>;\r\n  public readonly specifiers: ReadonlyMap<string, string>;\r\n  public readonly packages: ReadonlyMap<string, IPnpmShrinkwrapDependencyYaml>;\r\n\r\n  private readonly _shrinkwrapJson: IPnpmShrinkwrapYaml;\r\n  private _pnpmfileConfiguration: PnpmfileConfiguration | undefined;\r\n\r\n  private constructor(shrinkwrapJson: IPnpmShrinkwrapYaml, shrinkwrapFilename: string) {\r\n    super();\r\n    this.shrinkwrapFilename = shrinkwrapFilename;\r\n    this._shrinkwrapJson = shrinkwrapJson;\r\n\r\n    // Normalize the data\r\n    this.registry = shrinkwrapJson.registry || '';\r\n    this.dependencies = new Map(Object.entries(shrinkwrapJson.dependencies || {}));\r\n    this.importers = new Map(Object.entries(shrinkwrapJson.importers || {}));\r\n    this.specifiers = new Map(Object.entries(shrinkwrapJson.specifiers || {}));\r\n    this.packages = new Map(Object.entries(shrinkwrapJson.packages || {}));\r\n\r\n    // Importers only exist in workspaces\r\n    this.isWorkspaceCompatible = this.importers.size > 0;\r\n  }\r\n\r\n  public static loadFromFile(\r\n    shrinkwrapYamlFilename: string,\r\n    pnpmOptions: PnpmOptionsConfiguration\r\n  ): PnpmShrinkwrapFile | undefined {\r\n    try {\r\n      if (!FileSystem.exists(shrinkwrapYamlFilename)) {\r\n        return undefined; // file does not exist\r\n      }\r\n\r\n      const shrinkwrapContent: string = FileSystem.readFile(shrinkwrapYamlFilename);\r\n      const parsedData: IPnpmShrinkwrapYaml = yamlModule.safeLoad(shrinkwrapContent);\r\n      return new PnpmShrinkwrapFile(parsedData, shrinkwrapYamlFilename);\r\n    } catch (error) {\r\n      throw new Error(`Error reading \"${shrinkwrapYamlFilename}\":${os.EOL}  ${error.message}`);\r\n    }\r\n  }\r\n\r\n  public getShrinkwrapHash(experimentsConfig?: IExperimentsJson): string {\r\n    // The 'omitImportersFromPreventManualShrinkwrapChanges' experiment skips the 'importers' section\r\n    // when computing the hash, since the main concern is changes to the overall external dependency footprint\r\n    const { omitImportersFromPreventManualShrinkwrapChanges } = experimentsConfig || {};\r\n\r\n    const shrinkwrapContent: string = this._serializeInternal(\r\n      omitImportersFromPreventManualShrinkwrapChanges\r\n    );\r\n    return crypto.createHash('sha1').update(shrinkwrapContent).digest('hex');\r\n  }\r\n\r\n  /** @override */\r\n  public validate(\r\n    packageManagerOptionsConfig: PackageManagerOptionsConfigurationBase,\r\n    policyOptions: IShrinkwrapFilePolicyValidatorOptions,\r\n    experimentsConfig?: IExperimentsJson\r\n  ): void {\r\n    super.validate(packageManagerOptionsConfig, policyOptions);\r\n    if (!(packageManagerOptionsConfig instanceof PnpmOptionsConfiguration)) {\r\n      throw new Error('The provided package manager options are not valid for PNPM shrinkwrap files.');\r\n    }\r\n\r\n    if (!policyOptions.allowShrinkwrapUpdates) {\r\n      if (!policyOptions.repoState.isValid) {\r\n        console.log(\r\n          colors.red(\r\n            `The ${RushConstants.repoStateFilename} file is invalid. There may be a merge conflict marker ` +\r\n              'in the file. You may need to run \"rush update\" to refresh its contents.'\r\n          ) + os.EOL\r\n        );\r\n        throw new AlreadyReportedError();\r\n      }\r\n\r\n      // Only check the hash if allowShrinkwrapUpdates is false. If true, the shrinkwrap file\r\n      // may have changed and the hash could be invalid.\r\n      if (packageManagerOptionsConfig.preventManualShrinkwrapChanges) {\r\n        if (!policyOptions.repoState.pnpmShrinkwrapHash) {\r\n          console.log(\r\n            colors.red(\r\n              'The existing shrinkwrap file hash could not be found. You may need to run \"rush update\" to ' +\r\n                'populate the hash. See the \"preventManualShrinkwrapChanges\" setting documentation for details.'\r\n            ) + os.EOL\r\n          );\r\n          throw new AlreadyReportedError();\r\n        }\r\n\r\n        if (this.getShrinkwrapHash(experimentsConfig) !== policyOptions.repoState.pnpmShrinkwrapHash) {\r\n          console.log(\r\n            colors.red(\r\n              'The shrinkwrap file hash does not match the expected hash. Please run \"rush update\" to ensure the ' +\r\n                'shrinkwrap file is up to date. See the \"preventManualShrinkwrapChanges\" setting documentation for ' +\r\n                'details.'\r\n            ) + os.EOL\r\n          );\r\n          throw new AlreadyReportedError();\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /** @override */\r\n  public getTempProjectNames(): ReadonlyArray<string> {\r\n    return this._getTempProjectNames(this._shrinkwrapJson.dependencies || {});\r\n  }\r\n\r\n  /**\r\n   * Gets the path to the tarball file if the package is a tarball.\r\n   * Returns undefined if the package entry doesn't exist or the package isn't a tarball.\r\n   * Example of return value: file:projects/build-tools.tgz\r\n   */\r\n  public getTarballPath(packageName: string): string | undefined {\r\n    const dependency: IPnpmShrinkwrapDependencyYaml | undefined = this.packages.get(packageName);\r\n    return dependency?.resolution?.tarball;\r\n  }\r\n\r\n  public getTopLevelDependencyKey(dependencyName: string): string | undefined {\r\n    return this.dependencies.get(dependencyName);\r\n  }\r\n\r\n  /**\r\n   * Gets the version number from the list of top-level dependencies in the \"dependencies\" section\r\n   * of the shrinkwrap file. Sample return values:\r\n   *   '2.1.113'\r\n   *   '1.9.0-dev.27'\r\n   *   'file:projects/empty-webpart-project.tgz'\r\n   *   undefined\r\n   *\r\n   * @override\r\n   */\r\n  public getTopLevelDependencyVersion(dependencyName: string): DependencySpecifier | undefined {\r\n    let value: string | undefined = this.dependencies.get(dependencyName);\r\n    if (value) {\r\n      // Getting the top level dependency version from a PNPM lockfile version 5.1\r\n      // --------------------------------------------------------------------------\r\n      //\r\n      // 1) Top-level tarball dependency entries in pnpm-lock.yaml look like:\r\n      //    '@rush-temp/sp-filepicker': 'file:projects/sp-filepicker.tgz_0ec79d3b08edd81ebf49cd19ca50b3f5'\r\n\r\n      //    Then, it would be defined below:\r\n      //    'file:projects/sp-filepicker.tgz_0ec79d3b08edd81ebf49cd19ca50b3f5':\r\n      //      dependencies:\r\n      //       '@microsoft/load-themed-styles': 1.10.7\r\n      //       ...\r\n      //      resolution:\r\n      //       integrity: sha512-guuoFIc**==\r\n      //       tarball: 'file:projects/sp-filepicker.tgz'\r\n\r\n      //    Here, we are interested in the part 'file:projects/sp-filepicker.tgz'. Splitting by underscores is not the\r\n      //    best way to get this because file names could have underscores in them. Instead, we could use the tarball\r\n      //    field in the resolution section.\r\n\r\n      // 2) Top-level non-tarball dependency entries in pnpm-lock.yaml would look like:\r\n      //    '@rushstack/set-webpack-public-path-plugin': 2.1.133\r\n      //    @microsoft/sp-build-node': 1.9.0-dev.27_typescript@2.9.2\r\n\r\n      //    Here, we could just split by underscores and take the first part.\r\n\r\n      // The below code is also compatible with lockfile versions < 5.1\r\n\r\n      const dependency: IPnpmShrinkwrapDependencyYaml | undefined = this.packages.get(value);\r\n      if (dependency?.resolution?.tarball && value.startsWith(dependency.resolution.tarball)) {\r\n        return new DependencySpecifier(dependencyName, dependency.resolution.tarball);\r\n      } else {\r\n        const underscoreIndex: number = value.indexOf('_');\r\n        if (underscoreIndex >= 0) {\r\n          value = value.substr(0, underscoreIndex);\r\n        }\r\n      }\r\n\r\n      return new DependencySpecifier(dependencyName, value);\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * The PNPM shrinkwrap file has top-level dependencies on the temp projects like this:\r\n   *\r\n   * ```\r\n   * dependencies:\r\n   *   '@rush-temp/my-app': 'file:projects/my-app.tgz_25c559a5921686293a001a397be4dce0'\r\n   * packages:\r\n   *   /@types/node/10.14.15:\r\n   *     dev: false\r\n   *   'file:projects/my-app.tgz_25c559a5921686293a001a397be4dce0':\r\n   *     dev: false\r\n   *     name: '@rush-temp/my-app'\r\n   *     version: 0.0.0\r\n   * ```\r\n   *\r\n   * We refer to 'file:projects/my-app.tgz_25c559a5921686293a001a397be4dce0' as the temp project dependency key\r\n   * of the temp project '@rush-temp/my-app'.\r\n   */\r\n  public getTempProjectDependencyKey(tempProjectName: string): string | undefined {\r\n    const tempProjectDependencyKey: string | undefined = this.dependencies.get(tempProjectName);\r\n    return tempProjectDependencyKey ? tempProjectDependencyKey : undefined;\r\n  }\r\n\r\n  public getShrinkwrapEntryFromTempProjectDependencyKey(\r\n    tempProjectDependencyKey: string\r\n  ): IPnpmShrinkwrapDependencyYaml | undefined {\r\n    return this.packages.get(tempProjectDependencyKey);\r\n  }\r\n\r\n  public getShrinkwrapEntry(name: string, version: string): IPnpmShrinkwrapDependencyYaml | undefined {\r\n    // Version can sometimes be in the form of a path that's already in the /name/version format.\r\n    const packageId: string = version.indexOf('/') !== -1 ? version : `/${name}/${version}`;\r\n    return this.packages.get(packageId);\r\n  }\r\n\r\n  /**\r\n   * Serializes the PNPM Shrinkwrap file\r\n   *\r\n   * @override\r\n   */\r\n  protected serialize(): string {\r\n    return this._serializeInternal(false);\r\n  }\r\n\r\n  /**\r\n   * Gets the resolved version number of a dependency for a specific temp project.\r\n   * For PNPM, we can reuse the version that another project is using.\r\n   * Note that this function modifies the shrinkwrap data if tryReusingPackageVersionsFromShrinkwrap is set to true.\r\n   *\r\n   * @override\r\n   */\r\n  protected tryEnsureDependencyVersion(\r\n    dependencySpecifier: DependencySpecifier,\r\n    tempProjectName: string\r\n  ): DependencySpecifier | undefined {\r\n    // PNPM doesn't have the same advantage of NPM, where we can skip generate as long as the\r\n    // shrinkwrap file puts our dependency in either the top of the node_modules folder\r\n    // or underneath the package we are looking at.\r\n    // This is because the PNPM shrinkwrap file describes the exact links that need to be created\r\n    // to recreate the graph..\r\n    // Because of this, we actually need to check for a version that this package is directly\r\n    // linked to.\r\n\r\n    const packageName: string = dependencySpecifier.packageName;\r\n\r\n    const tempProjectDependencyKey: string | undefined = this.getTempProjectDependencyKey(tempProjectName);\r\n    if (!tempProjectDependencyKey) {\r\n      return undefined;\r\n    }\r\n\r\n    const packageDescription: IPnpmShrinkwrapDependencyYaml | undefined =\r\n      this._getPackageDescription(tempProjectDependencyKey);\r\n    if (\r\n      !packageDescription ||\r\n      !packageDescription.dependencies ||\r\n      !packageDescription.dependencies.hasOwnProperty(packageName)\r\n    ) {\r\n      return undefined;\r\n    }\r\n\r\n    const dependencyKey: string = packageDescription.dependencies[packageName];\r\n    return this._parsePnpmDependencyKey(packageName, dependencyKey);\r\n  }\r\n\r\n  /** @override */\r\n  public findOrphanedProjects(rushConfiguration: RushConfiguration): ReadonlyArray<string> {\r\n    // The base shrinkwrap handles orphaned projects the same across all package managers,\r\n    // but this is only valid for non-workspace installs\r\n    if (!this.isWorkspaceCompatible) {\r\n      return super.findOrphanedProjects(rushConfiguration);\r\n    }\r\n\r\n    const orphanedProjectPaths: string[] = [];\r\n    for (const importerKey of this.getImporterKeys()) {\r\n      // PNPM importer keys are relative paths from the workspace root, which is the common temp folder\r\n      const rushProjectPath: string = path.resolve(rushConfiguration.commonTempFolder, importerKey);\r\n      if (!rushConfiguration.tryGetProjectForPath(rushProjectPath)) {\r\n        orphanedProjectPaths.push(rushProjectPath);\r\n      }\r\n    }\r\n    return orphanedProjectPaths;\r\n  }\r\n\r\n  /** @override */\r\n  public getProjectShrinkwrap(project: RushConfigurationProject): PnpmProjectShrinkwrapFile | undefined {\r\n    return new PnpmProjectShrinkwrapFile(this, project);\r\n  }\r\n\r\n  public getImporterKeys(): ReadonlyArray<string> {\r\n    // Filter out the root importer used for the generated package.json in the root\r\n    // of the install, since we do not use this.\r\n    return [...this.importers.keys()].filter((k) => k !== '.');\r\n  }\r\n\r\n  public getImporterKeyByPath(workspaceRoot: string, projectFolder: string): string {\r\n    return Path.convertToSlashes(path.relative(workspaceRoot, projectFolder));\r\n  }\r\n\r\n  public getImporter(importerKey: string): IPnpmShrinkwrapImporterYaml | undefined {\r\n    return this.importers.get(importerKey);\r\n  }\r\n\r\n  /** @override */\r\n  public isWorkspaceProjectModified(project: RushConfigurationProject, variant?: string): boolean {\r\n    const importerKey: string = this.getImporterKeyByPath(\r\n      project.rushConfiguration.commonTempFolder,\r\n      project.projectFolder\r\n    );\r\n    const importer: IPnpmShrinkwrapImporterYaml | undefined = this.getImporter(importerKey);\r\n    if (!importer) {\r\n      return true;\r\n    }\r\n\r\n    // First, let's transform the package.json using the pnpmfile\r\n    const packageJson: IPackageJson = project.packageJsonEditor.saveToObject();\r\n\r\n    // Initialize the pnpmfile if it doesn't exist\r\n    if (!this._pnpmfileConfiguration) {\r\n      this._pnpmfileConfiguration = new PnpmfileConfiguration(project.rushConfiguration, { variant });\r\n    }\r\n\r\n    // Use a new PackageJsonEditor since it will classify each dependency type, making tracking the\r\n    // found versions much simpler.\r\n    const { dependencyList, devDependencyList } = PackageJsonEditor.fromObject(\r\n      this._pnpmfileConfiguration.transform(packageJson),\r\n      project.packageJsonEditor.filePath\r\n    );\r\n\r\n    // Then get the unique package names and map them to package versions.\r\n    const dependencyVersions: Map<string, PackageJsonDependency> = new Map();\r\n    for (const packageDependency of [...dependencyList, ...devDependencyList]) {\r\n      // We will also filter out peer dependencies since these are not installed at development time.\r\n      if (packageDependency.dependencyType === DependencyType.Peer) {\r\n        continue;\r\n      }\r\n\r\n      const foundDependency: PackageJsonDependency | undefined = dependencyVersions.get(\r\n        packageDependency.name\r\n      );\r\n      if (!foundDependency) {\r\n        dependencyVersions.set(packageDependency.name, packageDependency);\r\n      } else {\r\n        // Shrinkwrap will prioritize optional dependencies, followed by regular dependencies, with dev being\r\n        // the least prioritized. We will only keep the most prioritized option.\r\n        // See: https://github.com/pnpm/pnpm/blob/main/packages/lockfile-utils/src/satisfiesPackageManifest.ts\r\n        switch (foundDependency.dependencyType) {\r\n          case DependencyType.Optional:\r\n            break;\r\n          case DependencyType.Regular:\r\n            if (packageDependency.dependencyType === DependencyType.Optional) {\r\n              dependencyVersions.set(packageDependency.name, packageDependency);\r\n            }\r\n            break;\r\n          case DependencyType.Dev:\r\n            dependencyVersions.set(packageDependency.name, packageDependency);\r\n            break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Then validate that the dependency fields are as expected in the shrinkwrap to avoid false-negatives\r\n    // when moving a package from one field to the other.\r\n    for (const dependencyVersion of dependencyVersions.values()) {\r\n      switch (dependencyVersion.dependencyType) {\r\n        case DependencyType.Optional:\r\n          if (!importer.optionalDependencies || !importer.optionalDependencies[dependencyVersion.name])\r\n            return true;\r\n          break;\r\n        case DependencyType.Regular:\r\n          if (!importer.dependencies || !importer.dependencies[dependencyVersion.name]) return true;\r\n          break;\r\n        case DependencyType.Dev:\r\n          if (!importer.devDependencies || !importer.devDependencies[dependencyVersion.name]) return true;\r\n          break;\r\n      }\r\n    }\r\n\r\n    // Then validate the length matches between the importer and the dependency list, since duplicates are\r\n    // a valid use-case. Importers will only take one of these values, so no need to do more work here.\r\n    if (dependencyVersions.size !== Object.keys(importer.specifiers).length) {\r\n      return true;\r\n    }\r\n\r\n    // Finally, validate that all values in the importer are also present in the dependency list.\r\n    for (const [importerPackageName, importerVersionSpecifier] of Object.entries(importer.specifiers)) {\r\n      const foundDependency: PackageJsonDependency | undefined = dependencyVersions.get(importerPackageName);\r\n      if (!foundDependency || foundDependency.version !== importerVersionSpecifier) {\r\n        return true;\r\n      }\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Gets the package description for a tempProject from the shrinkwrap file.\r\n   */\r\n  private _getPackageDescription(\r\n    tempProjectDependencyKey: string\r\n  ): IPnpmShrinkwrapDependencyYaml | undefined {\r\n    const packageDescription: IPnpmShrinkwrapDependencyYaml | undefined =\r\n      this.packages.get(tempProjectDependencyKey);\r\n\r\n    return packageDescription && packageDescription.dependencies ? packageDescription : undefined;\r\n  }\r\n\r\n  private _parsePnpmDependencyKey(\r\n    dependencyName: string,\r\n    pnpmDependencyKey: string\r\n  ): DependencySpecifier | undefined {\r\n    if (pnpmDependencyKey) {\r\n      const result: DependencySpecifier | undefined = parsePnpmDependencyKey(\r\n        dependencyName,\r\n        pnpmDependencyKey\r\n      );\r\n\r\n      if (!result) {\r\n        throw new Error(\r\n          `Cannot parse PNPM shrinkwrap version specifier: \"${pnpmDependencyKey}\"` +\r\n            ` for \"${dependencyName}\"`\r\n        );\r\n      }\r\n\r\n      return result;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  private _serializeInternal(omitImporters: boolean = false): string {\r\n    // Ensure that if any of the top-level properties are provided but empty are removed. We populate the object\r\n    // properties when we read the shrinkwrap but PNPM does not set these top-level properties unless they are present.\r\n    const shrinkwrapToSerialize: { [key: string]: unknown } = {};\r\n    for (const [key, value] of Object.entries(this._shrinkwrapJson)) {\r\n      if (omitImporters && key === 'importers') {\r\n        continue;\r\n      }\r\n\r\n      if (!value || typeof value !== 'object' || Object.keys(value).length > 0) {\r\n        shrinkwrapToSerialize[key] = value;\r\n      }\r\n    }\r\n\r\n    return yamlModule.safeDump(shrinkwrapToSerialize, PNPM_SHRINKWRAP_YAML_FORMAT);\r\n  }\r\n}\r\n"]}