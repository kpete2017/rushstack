{"version":3,"file":"InstallHelpers.js","sourceRoot":"","sources":["../../../src/logic/installManager/InstallHelpers.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport colors from 'colors/safe';\r\nimport * as os from 'os';\r\nimport * as path from 'path';\r\nimport { FileConstants, FileSystem, IPackageJson, JsonFile, LockFile } from '@rushstack/node-core-library';\r\n\r\nimport { LastInstallFlag } from '../../api/LastInstallFlag';\r\nimport { PackageManagerName } from '../../api/packageManager/PackageManager';\r\nimport { RushConfiguration, IConfigurationEnvironment } from '../../api/RushConfiguration';\r\nimport { RushGlobalFolder } from '../../api/RushGlobalFolder';\r\nimport { Utilities } from '../../utilities/Utilities';\r\n\r\nexport class InstallHelpers {\r\n  public static generateCommonPackageJson(\r\n    rushConfiguration: RushConfiguration,\r\n    dependencies: Map<string, string> = new Map<string, string>()\r\n  ): void {\r\n    const commonPackageJson: IPackageJson = {\r\n      dependencies: {},\r\n      description: 'Temporary file generated by the Rush tool',\r\n      name: 'rush-common',\r\n      private: true,\r\n      version: '0.0.0'\r\n    };\r\n\r\n    // Add any preferred versions to the top of the commonPackageJson\r\n    // do this in alphabetical order for simpler debugging\r\n    for (const dependency of Array.from(dependencies.keys()).sort()) {\r\n      commonPackageJson.dependencies![dependency] = dependencies.get(dependency)!;\r\n    }\r\n\r\n    // Example: \"C:\\MyRepo\\common\\temp\\package.json\"\r\n    const commonPackageJsonFilename: string = path.join(\r\n      rushConfiguration.commonTempFolder,\r\n      FileConstants.PackageJson\r\n    );\r\n\r\n    // Don't update the file timestamp unless the content has changed, since \"rush install\"\r\n    // will consider this timestamp\r\n    JsonFile.save(commonPackageJson, commonPackageJsonFilename, { onlyIfChanged: true });\r\n  }\r\n\r\n  public static getPackageManagerEnvironment(\r\n    rushConfiguration: RushConfiguration,\r\n    options: {\r\n      debug?: boolean;\r\n    } = {}\r\n  ): NodeJS.ProcessEnv {\r\n    let configurationEnvironment: IConfigurationEnvironment | undefined = undefined;\r\n\r\n    if (rushConfiguration.packageManager === 'npm') {\r\n      if (rushConfiguration.npmOptions && rushConfiguration.npmOptions.environmentVariables) {\r\n        configurationEnvironment = rushConfiguration.npmOptions.environmentVariables;\r\n      }\r\n    } else if (rushConfiguration.packageManager === 'pnpm') {\r\n      if (rushConfiguration.pnpmOptions && rushConfiguration.pnpmOptions.environmentVariables) {\r\n        configurationEnvironment = rushConfiguration.pnpmOptions.environmentVariables;\r\n      }\r\n    } else if (rushConfiguration.packageManager === 'yarn') {\r\n      if (rushConfiguration.yarnOptions && rushConfiguration.yarnOptions.environmentVariables) {\r\n        configurationEnvironment = rushConfiguration.yarnOptions.environmentVariables;\r\n      }\r\n    }\r\n\r\n    return InstallHelpers._mergeEnvironmentVariables(process.env, configurationEnvironment, options);\r\n  }\r\n\r\n  /**\r\n   * If the \"(p)npm-local\" symlink hasn't been set up yet, this creates it, installing the\r\n   * specified (P)npm version in the user's home directory if needed.\r\n   */\r\n  public static async ensureLocalPackageManager(\r\n    rushConfiguration: RushConfiguration,\r\n    rushGlobalFolder: RushGlobalFolder,\r\n    maxInstallAttempts: number\r\n  ): Promise<void> {\r\n    // Example: \"C:\\Users\\YourName\\.rush\"\r\n    const rushUserFolder: string = rushGlobalFolder.nodeSpecificPath;\r\n\r\n    if (!FileSystem.exists(rushUserFolder)) {\r\n      console.log('Creating ' + rushUserFolder);\r\n      FileSystem.ensureFolder(rushUserFolder);\r\n    }\r\n\r\n    const packageManager: PackageManagerName = rushConfiguration.packageManager;\r\n    const packageManagerVersion: string = rushConfiguration.packageManagerToolVersion;\r\n\r\n    const packageManagerAndVersion: string = `${packageManager}-${packageManagerVersion}`;\r\n    // Example: \"C:\\Users\\YourName\\.rush\\pnpm-1.2.3\"\r\n    const packageManagerToolFolder: string = path.join(rushUserFolder, packageManagerAndVersion);\r\n\r\n    const packageManagerMarker: LastInstallFlag = new LastInstallFlag(packageManagerToolFolder, {\r\n      node: process.versions.node\r\n    });\r\n\r\n    console.log(`Trying to acquire lock for ${packageManagerAndVersion}`);\r\n\r\n    const lock: LockFile = await LockFile.acquire(rushUserFolder, packageManagerAndVersion);\r\n\r\n    console.log(`Acquired lock for ${packageManagerAndVersion}`);\r\n\r\n    if (!packageManagerMarker.isValid() || lock.dirtyWhenAcquired) {\r\n      console.log(colors.bold(`Installing ${packageManager} version ${packageManagerVersion}${os.EOL}`));\r\n\r\n      // note that this will remove the last-install flag from the directory\r\n      Utilities.installPackageInDirectory({\r\n        directory: packageManagerToolFolder,\r\n        packageName: packageManager,\r\n        version: rushConfiguration.packageManagerToolVersion,\r\n        tempPackageTitle: `${packageManager}-local-install`,\r\n        maxInstallAttempts: maxInstallAttempts,\r\n        // This is using a local configuration to install a package in a shared global location.\r\n        // Generally that's a bad practice, but in this case if we can successfully install\r\n        // the package at all, we can reasonably assume it's good for all the repositories.\r\n        // In particular, we'll assume that two different NPM registries cannot have two\r\n        // different implementations of the same version of the same package.\r\n        // This was needed for: https://github.com/microsoft/rushstack/issues/691\r\n        commonRushConfigFolder: rushConfiguration.commonRushConfigFolder\r\n      });\r\n\r\n      console.log(`Successfully installed ${packageManager} version ${packageManagerVersion}`);\r\n    } else {\r\n      console.log(`Found ${packageManager} version ${packageManagerVersion} in ${packageManagerToolFolder}`);\r\n    }\r\n\r\n    packageManagerMarker.create();\r\n\r\n    // Example: \"C:\\MyRepo\\common\\temp\"\r\n    FileSystem.ensureFolder(rushConfiguration.commonTempFolder);\r\n\r\n    // Example: \"C:\\MyRepo\\common\\temp\\pnpm-local\"\r\n    const localPackageManagerToolFolder: string = path.join(\r\n      rushConfiguration.commonTempFolder,\r\n      `${packageManager}-local`\r\n    );\r\n\r\n    console.log(os.EOL + `Symlinking \"${localPackageManagerToolFolder}\"`);\r\n    console.log(`  --> \"${packageManagerToolFolder}\"`);\r\n\r\n    // We cannot use FileSystem.exists() to test the existence of a symlink, because it will\r\n    // return false for broken symlinks.  There is no way to test without catching an exception.\r\n    try {\r\n      FileSystem.deleteFolder(localPackageManagerToolFolder);\r\n    } catch (error) {\r\n      if (error.code !== 'ENOENT') {\r\n        throw error;\r\n      }\r\n    }\r\n\r\n    FileSystem.createSymbolicLinkJunction({\r\n      linkTargetPath: packageManagerToolFolder,\r\n      newLinkPath: localPackageManagerToolFolder\r\n    });\r\n\r\n    lock.release();\r\n  }\r\n\r\n  // Helper for getPackageManagerEnvironment\r\n  private static _mergeEnvironmentVariables(\r\n    baseEnv: NodeJS.ProcessEnv,\r\n    environmentVariables?: IConfigurationEnvironment,\r\n    options: {\r\n      debug?: boolean;\r\n    } = {}\r\n  ): NodeJS.ProcessEnv {\r\n    const packageManagerEnv: NodeJS.ProcessEnv = baseEnv;\r\n\r\n    if (environmentVariables) {\r\n      // eslint-disable-next-line guard-for-in\r\n      for (const envVar in environmentVariables) {\r\n        let setEnvironmentVariable: boolean = true;\r\n        console.log(`\\nProcessing definition for environment variable: ${envVar}`);\r\n\r\n        if (baseEnv.hasOwnProperty(envVar)) {\r\n          setEnvironmentVariable = false;\r\n          console.log(`Environment variable already defined:`);\r\n          console.log(`  Name: ${envVar}`);\r\n          console.log(`  Existing value: ${baseEnv[envVar]}`);\r\n          console.log(`  Value set in rush.json: ${environmentVariables[envVar].value}`);\r\n\r\n          if (environmentVariables[envVar].override) {\r\n            setEnvironmentVariable = true;\r\n            console.log(`Overriding the environment variable with the value set in rush.json.`);\r\n          } else {\r\n            console.log(colors.yellow(`WARNING: Not overriding the value of the environment variable.`));\r\n          }\r\n        }\r\n\r\n        if (setEnvironmentVariable) {\r\n          if (options.debug) {\r\n            console.log(`Setting environment variable for package manager.`);\r\n            console.log(`  Name: ${envVar}`);\r\n            console.log(`  Value: ${environmentVariables[envVar].value}`);\r\n          }\r\n          packageManagerEnv[envVar] = environmentVariables[envVar].value;\r\n        }\r\n      }\r\n    }\r\n\r\n    return packageManagerEnv;\r\n  }\r\n}\r\n"]}